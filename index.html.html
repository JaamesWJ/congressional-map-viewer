<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congressional District Mapping Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shpjs/4.0.4/shp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
            background: white;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .btn {
            background: linear-gradient(135deg, #686761, #999894);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .btn-toggle {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-toggle:hover {
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 1px;
            padding: 0;
            min-height: 0;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.95); /* Change this line to white */
        }

        .main-content.fullscreen {
            padding: 0;
        }

        .map-container {
            flex: 1;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }

        .main-content.fullscreen .map-container {
            flex: 1;
        }

        #map {
            flex: 1;
            width: 100%;
            min-height: 400px;
        }

        .sidebar {
            display: none;
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar-resizer {
            display: none;
            width: 5px;
            background: rgba(102, 126, 234, 0.2);
            cursor: col-resize;
            flex-shrink: 0;
            position: relative;
            transition: background 0.2s ease;
        }

        .sidebar-resizer:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        .sidebar-resizer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 2px;
            width: 1px;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar.hidden {
            display: none;
        }

        .sidebar h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .district-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid rgba(46, 204, 113, 0.2);
        }

        .tooltip {
            background: white;
            color: #333;
            padding: 0;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid #ccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: nowrap;
            opacity: 0.95;
            width: auto !important;
            min-width: 0 !important;
            max-width: none !important;
            display: inline-block !important;
            box-sizing: border-box !important;
        }

        .tooltip-district-name {
            font-weight: bold;
            font-size: 15px;
            color: #000;
            padding: 8px 12px 2px 12px;
        }

        .tooltip-separator {
            height: 1px;
            background-color: #ddd;
            margin: 0;
        }

        .tooltip-labels {
            display: flex;
            padding: 0px 0 2px 0;
            gap: 0;
        }

        .tooltip-label {
            font-size: 12px;
            color: #666;
            padding: 0 12px;
            text-align: left;
        }

        .tooltip-label:nth-child(1) {
            flex: 1; /* Incumbent column takes remaining space */
        }

        .tooltip-label:nth-child(2) {
            width: 60px; /* Fixed width for Party */
            flex: none;
            text-align: center;
        }

        .tooltip-label:nth-child(3) {
            width: 60px; /* Fixed width for Margin */
            flex: none;
            text-align: center;
        }

        .tooltip-incumbent-line {
            display: flex;
            padding: 0;
            gap: 0;
            font-size: 14px;
            align-items: stretch;
            min-width: fit-content;
        }

        .tooltip-incumbent {
            font-weight: normal;
            color: white;
            padding: 4px 12px;
            border-radius: 0;
            flex: 1; /* Takes remaining space */
            text-align: left;
            white-space: nowrap;
            min-width: fit-content;
        }

        .tooltip-party {
            color: #666;
            padding: 4px 12px;
            display: flex;
            align-items: center;
            text-align: center;
            width: 60px; /* Fixed width matching label */
            flex: none;
            white-space: nowrap;
        }

        .tooltip-margin {
            color: #666;
            font-weight: bold;
            padding: 4px 12px;
            display: flex;
            align-items: center;
            text-align: center;
            width: 60px; /* Fixed width matching label */
            flex: none;
            white-space: nowrap;
        }

        .party-democratic {
            background-color: #4A90E2;
        }

        .party-republican {
            background-color: #E74C3C;
        }

        .party-none {
            background-color: #95A5A6;
            color: white;
        }

        .party-independent {
            background-color: #6AA84F;
            color: white;
        }

        .party-new-progressive {
            background-color: #161687;
            color: white;
        }

        .party-popular-democratic {
            background-color: #FF3333;
            color: white;
        }

        .party-alianza {
            background-color: #E0A230;
            color: white;
        }

        .party-project-dignity {
            background-color: #00ADC6;
            color: white;
        }

        /* Add the new CSS rules here: */
        .leaflet-tooltip {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ccc !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }

        .leaflet-tooltip-top:before {
            border-top-color: white !important;
        }

        .leaflet-tooltip-bottom:before {
            border-bottom-color: white !important;
        }

        .leaflet-tooltip:before {
            display: none !important;
        }

        .tooltip strong {
            color: #667eea;
        }

        .unique-id-display {
            font-family: monospace;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
            color: #667eea;
        }

        #borderThickness {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #ecf0f1 0%, #667eea 100%);
            outline: none;
            transition: all 0.3s ease;
        }

        #borderThickness::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        #borderThickness::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        #borderThickness::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .party-counter {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 40px 10px 40px;
            margin: 10px 20px 0px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .counter-numbers {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 2em;
            font-weight: 700;
        }

        .dem-count {
            color: #4A90E2;
        }

        .rep-count {
            color: #E74C3C;
        }

        .counter-bar {
            position: relative;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            background: #ecf0f1;
            margin-bottom: 8px;
        }

        .dem-section {
            background: #4A90E2;
            transition: width 0.3s ease;
        }

        .ind-section {
            background: #6AA84F;
            transition: width 0.3s ease;
        }

        .rep-section {
            background: #E74C3C;
            transition: width 0.3s ease;
        }

        .majority-line {
            position: absolute;
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            background: #2c3e50;
            z-index: 10;
            transform: translateX(-1px);
        }

        .majority-number {
            position: absolute;
            left: 50%;
            top: 18px;
            transform: translateX(-50%);
            font-size: 11px;
            color: #2c3e50;
            font-weight: 700;
            z-index: 11;
            background: rgba(255, 255, 255, 0.95);
            padding: 1px 4px;
            border-radius: 2px;
            border: 1px solid rgba(44, 62, 80, 0.2);
            white-space: nowrap;
            pointer-events: none;
        }

        .party-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }

        .dem-label, .rep-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dem-label .label-text {
            color: #4A90E2;
        }

        .rep-label .label-text {
            color: #E74C3C;
        }

        .majority-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dem-indicator {
            background: #4A90E2;
        }

        .rep-indicator {
            background: #E74C3C;
        }

        .majority-indicator.visible {
            opacity: 1;
        }

        .tab {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            color: #2c3e50;
            border: none;
            padding: 8px 16px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            margin-right: 2px;
        }

        .tab.active {
            background: linear-gradient(135deg, #686761, #999894);
            color: white;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: linear-gradient(135deg, #d5dbdb, #a6acaf);
        }

        .tab-close {
            margin-left: 8px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
        }

        .tab-close:hover {
            color: white;
        }

        .tab-name-input {
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.5);
            color: white;
            padding: 2px 4px;
            font-size: 11px;
            width: 80px;
            border-radius: 3px;
        }

        .tab-name-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab:not(.active) .tab-name-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px dashed rgba(0, 0, 0, 0.3);
            color: #2c3e50;
        }

        .tab:not(.active) .tab-name-input:focus {
            background: white;
            border-color: #667eea;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                text-align: center;
            }

            .leaflet-interactive:hover {
                stroke-dasharray: none !important;
                stroke-linecap: square !important;
                stroke-linejoin: miter !important;
            }

            .leaflet-zoom-animated .leaflet-interactive {
                stroke-width: 2 !important;
                stroke-dasharray: none !important;
                stroke-linecap: round !important;
                stroke-linejoin: round !important;
            }

            .leaflet-interactive {
                stroke-linecap: round !important;
                stroke-linejoin: round !important;
            }
        }

        .top-bar {
            background: #f8f9fa;
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .left-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .right-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            background: white !important;
            color: #666 !important;
            border: 1px solid #ddd !important;
            padding: 12px;
            border-radius: 8px; /* Changed from 50% to 8px for rounded squares */
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            background: #f8f9fa !important;
        }

        /* Special styling for clear button */
        /* Make clear button more red */
        #clearBtn {
            background: white !important;
            color: #dc3545 !important;
            border-color: #dc3545 !important;
        }

        #clearBtn:hover {
            background: #dc3545 !important;
            color: white !important;
        }

        .icon-btn .icon {
            font-size: 18px;
            line-height: 1;
        }

        .tabs-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-tab-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px; /* Changed from 50% */
            cursor: pointer;
            font-size: 18px;
            font-weight: normal; /* Changed from bold */
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            width: auto; /* Changed from fixed width */
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px;
        }

        .add-tab-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            max-height: 80vh;
            width: 90%;
            overflow: hidden;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-container {
            transform: translateY(0);
        }

        .modal-content {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            color: #2c3e50;
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .file-upload-option {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-upload-option:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }

        .file-upload-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .file-upload-desc {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .settings-grid {
            display: grid;
            gap: 25px;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: auto;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .color-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
        }

        .color-label {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
        }

        .color-option select {
            padding: 8px 12px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .header,
        body.dark-mode .top-bar,
        body.dark-mode .party-counter,
        body.dark-mode .sidebar {
        background: rgba(52, 73, 94, 0.95);
        color: #ecf0f1;
        }

        body.dark-mode .main-content {
            background: rgba(52, 73, 94, 0.95);
        }

        body.dark-mode .map-container {
            background: #2c3e50;
            border-color: rgba(52, 73, 94, 0.5);
        }

        body.dark-mode h1, 
        body.dark-mode h2, 
        body.dark-mode h3,
        body.dark-mode label,
        body.dark-mode .modal-title {
            color: #ecf0f1;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select {
            background: rgba(52, 73, 94, 0.8);
            color: #ecf0f1;
            border-color: #5a6c7d;
        }

        body.dark-mode .district-info,
        body.dark-mode .settings-section {
            background: rgba(52, 73, 94, 0.5);
            color: #ecf0f1;
        }

        body.dark-mode .modal-container {
            background: #34495e;
            color: #ecf0f1;
        }

        body.dark-mode .modal-content {
            background: #34495e;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode select {
            background: #2c3e50;
            color: #ecf0f1;
            border-color: #5a6c7d;
        }

        body.dark-mode .file-upload-option {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-color: #5a6c7d;
            color: #ecf0f1;
        }

        body.dark-mode .file-upload-option:hover {
            border-color: #3498db;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        body.dark-mode .file-upload-title,
        body.dark-mode .file-upload-desc {
            color: inherit;
        }

        body.dark-mode .modal-container {
             background: #34495e;
            color: #ecf0f1;
        }

        body.dark-mode .modal-content .district-info,
        body.dark-mode .modal-container > div:first-child {
            background: rgba(44, 62, 80, 0.7) !important;
            color: #ecf0f1 !important;
            border-left-color: #3498db !important;
        }

        body.dark-mode .modal-content .unique-id-display {
            background: rgba(52, 73, 94, 0.3) !important;
            color: #3498db !important;
        }

        body.dark-mode .modal-content {
            background: #34495e;
            color: #ecf0f1;
        }

        body.dark-mode .modal-content input,
        body.dark-mode .modal-content select,
        body.dark-mode #modalDistrictName,
        body.dark-mode #modalSingleIncumbent,
        body.dark-mode #modalMargin,
        body.dark-mode #modalParty {
            background: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-color: #5a6c7d !important;
        }

        body.dark-mode .modal-content input::placeholder {
            color: #95a5a6 !important;
        }

        body.dark-mode .modal-content label {
            color: #ecf0f1 !important;
        }

        body.dark-mode .modal-incumbent-row,
        body.dark-mode .modal-special-incumbent-row {
            background: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-color: #5a6c7d !important;
        }

        body.dark-mode .modal-incumbent-input,
        body.dark-mode .modal-incumbent-party,
        body.dark-mode .modal-incumbent-margin,
        body.dark-mode .modal-special-incumbent-input,
        body.dark-mode .modal-special-incumbent-party,
        body.dark-mode .modal-special-incumbent-margin {
            background: #34495e !important;
            color: #ecf0f1 !important;
            border-color: #5a6c7d !important;
        }

        body.dark-mode #modalSpecialElectionContainer {
            background: rgba(44, 62, 80, 0.5) !important;
            border-color: #5a6c7d !important;
        }

        body.dark-mode #modalSpecialIncumbent,
        body.dark-mode #modalSpecialParty,
        body.dark-mode #modalSpecialMargin {
            background: #34495e !important;
            color: #ecf0f1 !important;
            border-color: #5a6c7d !important;
        }
        
        body.dark-mode .sidebar .district-info,
        body.dark-mode #districtForm .district-info {
            background: rgba(52, 73, 94, 0.5) !important;
            color: #ecf0f1 !important;
            border-left-color: #3498db !important;
        }

        body.dark-mode .sidebar .unique-id-display
        body.dark-mode #districtForm .unique-id-display {
            background: rgba(52, 73, 94, 0.3) !important;
            color: #3498db !important;
        }

        body.dark-mode .district-info,
        body.dark-mode .modal-container .district-info {
            background: rgba(52, 73, 94, 0.5) !important;
            color: #ecf0f1 !important;
            border-left-color: #3498db !important;
        }

        body.dark-mode .unique-id-display,
        body.dark-mode .modal-container .unique-id-display {
            background: rgba(52, 73, 94, 0.3) !important;
            color: #3498db !important;
        }

        .modal-content * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-content input,
        .modal-content textarea,
        .modal-content select {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        body.dark-mode .custom-party-item {
            background: rgba(52, 73, 94, 0.5) !important;
            color: #ecf0f1 !important;
        }

        body.dark-mode .custom-party-item h4 {
            color: #ecf0f1 !important;
        }

        body.dark-mode .custom-party-name,
        body.dark-mode .custom-party-abbrev {
            background: #2c3e50 !important;
            color: #ecf0f1 !important;
            border-color: #5a6c7d !important;
        }

        body.dark-mode .remove-custom-party {
            background: #e74c3c !important;
            color: white !important;
        }

    </style>
</head>
<body>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div id="modalContent" class="modal-content">
            </div>
        </div>
    </div>
    <!-- Hidden file inputs -->
     <input type="file" id="mapFileInput" accept=".geojson,.json,.shp,.zip" multiple style="display: none;">
     <input type="file" id="dataFileInput" accept=".json" style="display: none;">

        <div class="top-bar">
            <div class="left-controls">
                <button id="uploadBtn" class="icon-btn" title="Load Files">
                    <img src="https://i.imgur.com/hSpKj5G.png" alt="Upload" style="width: 25px; height: 25px;">
                </button>
                <button id="saveBtn" class="icon-btn" title="Save Map Data">
                    <img src="https://i.imgur.com/q1xcQSx.png" alt="Save" style="width: 25px; height: 25px;">
                </button>
                <button id="settingsBtn" class="icon-btn" title="Map Settings">
                    <img src="https://i.imgur.com/gtSlImX.png" alt="Map Settings" style="width: 25px; height: 25px;">
                </button>
                <button id="colorsBtn" class="icon-btn" title="Color Settings">
                    <img src="https://i.imgur.com/wAmGwVz.png" alt="Color Settings" style="width: 25px; height: 25px;">
                </button>
                <button id="customPartiesBtn" class="icon-btn" title="Custom Parties">
                    <img src="https://i.imgur.com/8AfThjJ.png" alt="Custom Parties" style="width: 25px; height: 25px;">
                </button>
                <button id="clearBtn" class="icon-btn" title="Clear Data">
                    <img src="https://i.imgur.com/iqQPOeW.png" alt="Clear Map" style="width: 25px; height: 25px;">
                </button>
                <div id="topBarStatus" style="margin-left: 15px; padding: 8px 15px; background: rgba(46, 204, 113, 0.1); color: #27ae60; border-radius: 8px; font-size: 14px; font-weight: 500; border: 1px solid rgba(46, 204, 113, 0.2);">
                    Load a GeoJSON or Shapefile to begin
                </div>
            </div>

            <div class="right-controls">
                <div class="tabs-container">
                    <div class="tabs-header" style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <!-- Tabs will be dynamically added here -->
                    </div>
                    <button id="addTerm" class="add-tab-btn">+</button>
                </div>
            </div>
        </div>

        <!-- Add this new section -->
        <div class="party-counter" id="partyCounter" style="display: none;">
            <div class="counter-numbers">
                <span class="dem-count">0</span>
                <span class="rep-count">0</span>
            </div>
            <div class="counter-bar">
                <div class="dem-section"></div>
                <div class="ind-section"></div>
                <div class="rep-section"></div>
                <div class="majority-line"></div>
                <div class="majority-number"></div>
            </div>
            <div class="party-labels">
                <div class="dem-label">
                    <span class="majority-indicator dem-indicator">✓</span>
                    <span class="label-text">Democrats</span>
                </div>
                <div class="rep-label">
                    <span class="label-text">Republicans</span>
                    <span class="majority-indicator rep-indicator">✓</span>
                </div>
            </div>
        </div>
    </div>



    <div class="main-content" id="mainContent">
        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="sidebar-resizer" id="sidebarResizer"></div>
        <div class="sidebar" id="sidebar">
            <h2>District Editor</h2>
            <div id="status" class="status">Load a GeoJSON or Shapefile to begin</div>
            
            <div id="districtForm" style="display: none;">
                <div class="district-info">
                    <strong>Selected District ID: </strong><span id="selectedDistrict">None</span>
                    <div class="unique-id-display" id="uniqueIdDisplay"></div>
                </div>
                
                <div class="form-group">
                    <label for="districtName">District Name/Number:</label>
                    <input type="text" id="districtName" placeholder="e.g., ME-2, California 7th, etc.">
                </div>
                
                <div class="form-group">
                    <label>Congressional Incumbent(s):</label>
                    <div id="incumbentContainer">
                        <div class="incumbent-row" data-index="0">
                            <input type="text" class="incumbent-input" placeholder="Enter incumbent name" style="margin-bottom: 8px;">
                            <select class="incumbent-party" style="margin-bottom: 8px; display: none;">
                                <option value="">Select Party</option>
                                <option value="Democratic">Democratic</option>
                                <option value="Republican">Republican</option>
                                <option value="Independent">Independent</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" id="addIncumbent" class="btn" style="display: none; margin-top: 10px; font-size: 12px; padding: 8px 16px;">+ Add Incumbent</button>
                </div>
                
                <div class="form-group">
                    <label for="margin">Election Margin (%):</label>
                    <input type="number" id="margin" step="0.1" placeholder="Enter margin (e.g., 5.2)">
                </div>

                <div id="specialElectionContainer" style="display: none; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ecf0f1;">
                    <label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbent:</label>
                    <input type="text" id="specialIncumbentInput" placeholder="Enter special election incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                    <select id="specialIncumbentParty" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                        <option value="">Select Party</option>
                        <option value="Democratic">Democratic</option>
                        <option value="Republican">Republican</option>
                        <option value="Independent">Independent</option>
                    </select>
                    <input type="number" id="specialIncumbentMargin" placeholder="Special election margin %" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                </div>
                
                <div class="form-group">
                    <label for="multiMemberToggle" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="multiMemberToggle" style="width: auto; margin: 0;">
                        Multi-member district
                    </label>
                </div>

                <div class="form-group">
                    <label for="specialElectionToggle" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="specialElectionToggle" style="width: auto; margin: 0;">
                        Include special election
                    </label>
                </div>

                <div id="prPartiesGroup" class="form-group">
                    <label for="prPartiesToggle" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="prPartiesToggle" style="width: auto; margin: 0;">
                        Use Puerto Rican parties
                    </label>
                </div>

                <div class="form-group" id="singlePartyGroup">
                    <label for="party">Party Control:</label>
                    <select id="party">
                        <option value="">Select Party</option>
                        <option value="Democratic">Democratic</option>
                        <option value="Republican">Republican</option>
                        <option value="Independent">Independent</option>
                    </select>
                </div>
                
                <button id="updateDistrict" class="btn">✏️ Update District</button>
            </div>

            <div class="form-group" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                <label for="borderThickness">Border Thickness:</label>
                <input type="range" id="borderThickness" min="0.25" max="4" value="1" step="0.05">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                    <span>Thin (.25px)</span>
                    <span>Thick (4px)</span>
                </div>
                <div style="text-align: center; margin-top: 8px; font-weight: 500; color: #2c3e50;">
                    Current: <span id="borderValue">2</span>px
                </div>
            </div>

            <div class="form-group">
                <label for="fillOpacity">Fill Opacity:</label>
                <input type="range" id="fillOpacity" min="0.1" max="1" value="0.7" step="0.05">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                    <span>Transparent (0.1)</span>
                    <span>Opaque (1.0)</span>
                </div>
                <div style="text-align: center; margin-top: 8px; font-weight: 500; color: #2c3e50;">
                    Current: <span id="opacityValue">0.3</span>
                </div>
            </div>

            <div class="form-group">
                <label for="borderColor">Border Color:</label>
                <select id="borderColor">
                    <option value="black">Black</option>
                    <option value="white">White</option>
                </select>
            </div>

            <div class="form-group">
                <label for="autoZoomToggle" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="autoZoomToggle" checked style="width: auto; margin: 0;">
                    Auto-zoom to selected districts
                </label>
            </div>

            <div class="form-group">
                <label for="backgroundMap">Background Map Style:</label>
                <select id="backgroundMap">
                    <option value="openstreetmap">OpenStreetMap (Default)</option>
                    <option value="cartodb-light">CartoDB Light (NYT-style)</option>
                    <option value="cartodb-dark">CartoDB Dark</option>
                    <option value="stamen-toner">Stamen Toner (B&W)</option>
                    <option value="esri-world">ESRI World Street</option>
                    <option value="esri-satellite">ESRI Satellite</option>
                    <option value="cartodb-positron">CartoDB Positron (Clean)</option>
                    <option value="cartodb-dark-nolabels">CartoDB Dark (Clean)</option>
                    <option value="esri-world-gray">ESRI Light Gray</option>
                    <option value="stamen-terrain">Stamen Terrain</option>
                </select>
            </div>

            <div class="form-group" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">
                <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2em;">Party Color Settings</h3>

                <div class="form-group">
                    <label for="democraticColor">Democratic Party Color:</label>
                    <select id="democraticColor">
                        <option value="#7380D9">Default Democratic Blue</option>
                        <option value="#CCCCCC">YAPMS Tossup</option>
                        <option value="#1C408C">YAPMS Blue</option>
                        <option value="#BF1D29">YAPMS Red</option>
                        <option value="#E6B700">YAPMS Yellow</option>
                        <option value="#1C8C28">YAPMS Green</option>
                        <option value="#822194">YAPMS Purple</option>
                        <option value="#737373">Wikipedia Grey</option>
                        <option value="#EC7014">Wikipedia Orange</option>
                        <option value="#D72F30">Wikipedia Red</option>
                        <option value="#584CDE">Wikipedia Blue</option>
                        <option value="#DEB02A">Wikipedia Yellow</option>
                        <option value="#CA7F8B">DRA Dark Red</option>
                        <option value="#FF8F8F">DRA Red</option>
                        <option value="#7F7FC5">DRA Dark Blue</option>
                        <option value="#8F8FFF">DRA Blue</option>
                        <option value="#161687">PR New Progressive</option>
                        <option value="#FF3333">PR Popular Democratic</option>
                        <option value="#E0A230">PR Alianza</option>
                        <option value="#009C4D">PR Alianza Alternate</option>
                        <option value="#00ADC6">PR Project Dignity</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="color" id="democraticColorPicker" style="display: none; margin-top: 10px; width: 100%; height: 40px; border: none; border-radius: 8px;">
                </div>

                <div class="form-group">
                    <label for="republicanColor">Republican Party Color:</label>
                    <select id="republicanColor">
                        <option value="#B06361">Default Republican Red</option>
                        <option value="#CCCCCC">YAPMS Tossup</option>
                        <option value="#1C408C">YAPMS Blue</option>
                        <option value="#BF1D29">YAPMS Red</option>
                        <option value="#E6B700">YAPMS Yellow</option>
                        <option value="#1C8C28">YAPMS Green</option>
                        <option value="#822194">YAPMS Purple</option>
                        <option value="#737373">Wikipedia Grey</option>
                        <option value="#EC7014">Wikipedia Orange</option>
                        <option value="#D72F30">Wikipedia Red</option>
                        <option value="#584CDE">Wikipedia Blue</option>
                        <option value="#DEB02A">Wikipedia Yellow</option>
                        <option value="#CA7F8B">DRA Dark Red</option>
                        <option value="#FF8F8F">DRA Red</option>
                        <option value="#7F7FC5">DRA Dark Blue</option>
                        <option value="#8F8FFF">DRA Blue</option>
                        <option value="#161687">PR New Progressive</option>
                        <option value="#FF3333">PR Popular Democratic</option>
                        <option value="#E0A230">PR Alianza</option>
                        <option value="#009C4D">PR Alianza Alternate</option>
                        <option value="#00ADC6">PR Project Dignity</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="color" id="republicanColorPicker" style="display: none; margin-top: 10px; width: 100%; height: 40px; border: none; border-radius: 8px;">
                </div>

                <div class="form-group">
                    <label for="independentColor">Independent Party Color:</label>
                    <select id="independentColor">
                        <option value="#D9EAD3">Default Independent Green</option>
                        <option value="#CCCCCC">YAPMS Tossup</option>
                        <option value="#1C408C">YAPMS Blue</option>
                        <option value="#BF1D29">YAPMS Red</option>
                        <option value="#E6B700">YAPMS Yellow</option>
                        <option value="#1C8C28">YAPMS Green</option>
                        <option value="#822194">YAPMS Purple</option>
                        <option value="#737373">Wikipedia Grey</option>
                        <option value="#EC7014">Wikipedia Orange</option>
                        <option value="#D72F30">Wikipedia Red</option>
                        <option value="#584CDE">Wikipedia Blue</option>
                        <option value="#DEB02A">Wikipedia Yellow</option>
                        <option value="#CA7F8B">DRA Dark Red</option>
                        <option value="#FF8F8F">DRA Red</option>
                        <option value="#7F7FC5">DRA Dark Blue</option>
                        <option value="#8F8FFF">DRA Blue</option>
                        <option value="#161687">PR New Progressive</option>
                        <option value="#FF3333">PR Popular Democratic</option>
                        <option value="#E0A230">PR Alianza</option>
                        <option value="#009C4D">PR Alianza Alternate</option>
                        <option value="#00ADC6">PR Project Dignity</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="color" id="independentColorPicker" style="display: none; margin-top: 10px; width: 100%; height: 40px; border: none; border-radius: 8px;">
                </div>

                <div class="form-group">
                    <label for="unsetColor">Unset Districts Color:</label>
                    <select id="unsetColor">
                        <option value="#AF9A44">Default Unset Yellow</option>
                        <option value="#CCCCCC">YAPMS Tossup</option>
                        <option value="#1C408C">YAPMS Blue</option>
                        <option value="#BF1D29">YAPMS Red</option>
                        <option value="#E6B700">YAPMS Yellow</option>
                        <option value="#1C8C28">YAPMS Green</option>
                        <option value="#822194">YAPMS Purple</option>
                        <option value="#737373">Wikipedia Grey</option>
                        <option value="#EC7014">Wikipedia Orange</option>
                        <option value="#D72F30">Wikipedia Red</option>
                        <option value="#584CDE">Wikipedia Blue</option>
                        <option value="#DEB02A">Wikipedia Yellow</option>
                        <option value="#CA7F8B">DRA Dark Red</option>
                        <option value="#FF8F8F">DRA Red</option>
                        <option value="#7F7FC5">DRA Dark Blue</option>
                        <option value="#8F8FFF">DRA Blue</option>
                        <option value="#161687">PR New Progressive</option>
                        <option value="#FF3333">PR Popular Democratic</option>
                        <option value="#E0A230">PR Alianza</option>
                        <option value="#009C4D">PR Alianza Alternate</option>
                        <option value="#00ADC6">PR Project Dignity</option>
                        <option value="custom">Custom Color...</option>
                    </select>
                    <input type="color" id="unsetColorPicker" style="display: none; margin-top: 10px; width: 100%; height: 40px; border: none; border-radius: 8px;">
                </div>
            </div>
        </div>
    </div>

    <script>
        class CongressionalMapTool {
            constructor() {''
                this.map = null;
                this.currentLayer = null;
                this.selectedDistrict = null;
                this.uniqueIdCounter = 1;
                this.isFullscreen = true;
                this.borderThickness = 1; // Default border thickness
                this.autoZoomEnabled = true;

                // Move partyColors initialization here - VERY IMPORTANT
                this.partyColors = {
                    'Democratic': '#7380D9',
                    'Republican': '#B06361',
                    'Independent': '#6AA84F',
                    'unset': '#AF9A44',
                    'New Progressive': '#161687',
                    'Popular Democratic': '#FF3333',
                    'Alianza': '#E0A230',
                    'Project Dignity': '#00ADC6'
                };
                
                this.fillOpacity = 0.7; // Set default to 0.7
                this.borderOpacity = 1.0; // Add border opacity property
                this.initializeMap();
                this.bindEvents();
                this.currentTileLayer = null;
                this.borderColor = 'black'; // Default border color
                this.isMultiMember = false;
                this.incumbentData = [];
                this.usePRParties = false;
                this.congressionalTerms = {
                    'term_1': {
                        name: '118th Congress',
                        data: {}
                    }
                };
                this.currentTerm = 'term_1';
                this.renderTabs();
                this.termCounter = 1;
                this.darkMode = false; // Add this property
                this.updatePRPartiesVisibility(); // Add this line here
                this.customPartiesEnabled = false;
                this.customParties = []; // Array of {name: "Party Name", abbreviation: "PRT", color: "#color"}
            }

            initializeMap() {
                this.map = L.map('map', {
                    preferCanvas: true,
                    zoomControl: true,
                }).setView([39.8283, -98.5795], 4);

                // ADD THIS: Create custom reset zoom control
                const resetControl = L.Control.extend({
                    options: {
                        position: 'topleft'
                    },
                    onAdd: function(map) {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                        const resetButton = L.DomUtil.create('a', 'leaflet-control-zoom-reset', container);
                        resetButton.href = '#';
                        resetButton.title = 'Reset View';
                        resetButton.innerHTML = '<img src="https://i.imgur.com/y5nwjrC.png" alt="Reset" style="width: 18px; height: 18px; display: block; margin: 0 auto;">';
                        resetButton.style.display = 'flex';
                        resetButton.style.alignItems = 'center';
                        resetButton.style.justifyContent = 'center';
                        resetButton.style.textAlign = 'center';

                        L.DomEvent.on(resetButton, 'click', function(e) {
                            L.DomEvent.preventDefault(e);
                            if (this.currentLayer) {
                                map.fitBounds(this.currentLayer.getBounds());
                            } else {
                                map.setView([39.8283, -98.5795], 4);
                            }
                        }, this);

                        return container;
                    }
                });

                // Add the custom control to the map
                new resetControl().addTo(this.map);

                // Initialize fullscreen state
                setTimeout(() => {
                    if (this.isFullscreen) {
                        document.getElementById('sidebar').style.display = 'none';
                        document.getElementById('sidebarResizer').style.display = 'none';
                        document.getElementById('mainContent').classList.add('fullscreen');
                    }
                }, 100);

                // Set initial tile layer
                this.setTileLayer('openstreetmap');
                // Set default border color
                document.getElementById('borderColor').value = 'black';
            }

            setTileLayer(mapType) {
                // Remove existing tile layer if it exists
                if (this.currentTileLayer) {
                    this.map.removeLayer(this.currentTileLayer);
                }

                let tileUrl, attribution, options = {};

                switch (mapType) {
                    case 'openstreetmap':
                        tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                        attribution = '© OpenStreetMap contributors';
                        options = {
                            maxZoom: 18,
                            subdomains: ['a', 'b', 'c']
                        };
                        break;

                    case 'cartodb-light':
                        tileUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                        attribution = '© OpenStreetMap contributors, © CARTO';
                        options = {
                            maxZoom: 19,
                            subdomains: 'abcd'
                        };
                        break;
                    
                    case 'cartodb-dark':
                        tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                        attribution = '© OpenStreetMap contributors, © CARTO';
                        options = {
                            maxZoom: 19,
                            subdomains: 'abcd'
                        };
                        break;

                    case 'stamen-toner':
                        tileUrl = 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
                        attribution = '© OpenStreetMap contributors, © CARTO';
                        options = {
                            maxZoom: 19,
                            subdomains: 'abcd'
                        };
                        break;
                    
                    case 'esri-world':
                        tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}';
                        attribution = 'Tiles © Esri — Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012';
                        options = {
                            maxZoom: 18
                        };
                        break;

                    case 'esri-satellite':
                        tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                        attribution = 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';
                        options = {
                            maxZoom: 18
                        };
                        break;
                    
                    case 'dark human geography':
                        tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                        attribution = 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';
                        options = {
                            maxZoom: 18
                        };
                        break;
                    
                    case 'cartodb-positron':
                        tileUrl = 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
                        attribution = '© OpenStreetMap contributors, © CARTO';
                        options = {
                            maxZoom: 19,
                            subdomains: 'abcd'
                        };
                        break;

                    case 'cartodb-dark-nolabels':
                        tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png';
                        attribution = '© OpenStreetMap contributors, © CARTO';
                        options = {
                            maxZoom: 19,
                            subdomains: 'abcd'
                        };
                        break;

                    case 'esri-world-gray':
                        tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}';
                        attribution = 'Tiles © Esri';
                        options = {
                            maxZoom: 16
                        };
                        break;

                    case 'stamen-terrain':
                        tileUrl = 'https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg';
                        attribution = 'Map tiles by Stamen Design, CC BY 3.0';
                        options = {
                            maxZoom: 18
                        };
                        break;
                }

                // Common options for all tile layers
                const commonOptions = {
                    attribution: attribution,
                    minZoom: 2,
                    detectRetina: true,
                    updateWhenIdle: false,
                    keepBuffer: 8,
                    tileSize: 256
                };

                // Merge specific options with common options
                const finalOptions = { ...commonOptions, ...options };

                // Create and add the new tile layer
                this.currentTileLayer = L.tileLayer(tileUrl, finalOptions);
                this.currentTileLayer.addTo(this.map);
            }

            preloadTiles() {
                if (!this.currentLayer) return;

                const bounds = this.currentLayer.getBounds();
                const currentZoom = this.map.getZoom();

                // Preload tiles for next zoom levels
                for (let z = currentZoom + 1; z <= Math.min(currentZoom + 2, 10); z++) {
                    this.map.fire('moveend');
                }
            }

            bindEvents() {
                // New modal-based event handlers
                document.getElementById('uploadBtn').addEventListener('click', () => {
                    this.showUploadModal();
                });

                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.saveMapData();
                });
                
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showSettingsModal();
                });

                document.getElementById('colorsBtn').addEventListener('click', () => {
                    this.showColorsModal();
                });

                document.getElementById('customPartiesBtn').addEventListener('click', () => {
                    this.showCustomPartiesModal();
                });

                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearMapData(); // New method - only clears data, not map
                });

                // File input handlers
                document.getElementById('mapFileInput').addEventListener('change', (e) => {
                    this.loadMapFile(e.target.files);
                    this.hideModal();
                });

                document.getElementById('dataFileInput').addEventListener('change', (e) => {
                    this.loadMapData(e.target.files[0]);
                    this.hideModal();
                });

                // Modal close handlers
                document.getElementById('modalOverlay').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('modalOverlay')) {
                        this.hideModal();
                    }
                });

                // Congressional terms controls
                document.getElementById('addTerm').addEventListener('click', () => {
                    this.addCongressionalTerm();
                });

                document.getElementById('mapFileInput').addEventListener('change', (e) => {
                    this.loadMapFile(e.target.files);
                });

                document.getElementById('updateDistrict').addEventListener('click', () => {
                    console.log('About to call updateDistrictData, selectedDistrict is:', this.selectedDistrict);
                    this.updateDistrictData();
                });

                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearMapData(); // Note: also changed method name
                });

                // Border thickness control
                document.getElementById('borderThickness').addEventListener('input', (e) => {
                    this.borderThickness = parseFloat(e.target.value);
                    document.getElementById('borderValue').textContent = this.borderThickness;
                    this.updateAllBorders();
                });

                // Fill opacity control
                document.getElementById('fillOpacity').addEventListener('input', (e) => {
                    this.fillOpacity = parseFloat(e.target.value);
                    document.getElementById('opacityValue').textContent = this.fillOpacity;
                    this.updateAllBorders();
                });

                document.getElementById('autoZoomToggle').addEventListener('change', (e) => {
                    this.autoZoomEnabled = e.target.checked;
                });

                document.getElementById('backgroundMap').addEventListener('change', (e) => {
                    this.setTileLayer(e.target.value);
                });

                document.getElementById('borderColor').addEventListener('change', (e) => {
                    this.borderColor = e.target.value;
                    this.updateAllBorders();
                });

                // Handle window resize to update map
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        this.map.invalidateSize();
                    }, 100);
                });

                // Party color controls
                document.getElementById('democraticColor').addEventListener('change', (e) => {
                    this.handleColorChange('Democratic', e.target.value, 'democraticColorPicker');
                });

                document.getElementById('republicanColor').addEventListener('change', (e) => {
                    this.handleColorChange('Republican', e.target.value, 'republicanColorPicker');
                });

                document.getElementById('independentColor').addEventListener('change', (e) => {
                    this.handleColorChange('Independent', e.target.value, 'independentColorPicker');
                });

                document.getElementById('unsetColor').addEventListener('change', (e) => {
                    this.handleColorChange('unset', e.target.value, 'unsetColorPicker');
                });

                document.getElementById('democraticColorPicker').addEventListener('change', (e) => {
                    this.partyColors['Democratic'] = e.target.value;
                    this.updateAllBorders();
                });

                document.getElementById('republicanColorPicker').addEventListener('change', (e) => {
                    this.partyColors['Republican'] = e.target.value;
                    this.updateAllBorders();
                });

                document.getElementById('independentColorPicker').addEventListener('change', (e) => {
                    this.partyColors['Independent'] = e.target.value;
                    this.updateAllBorders();
                });

                document.getElementById('unsetColorPicker').addEventListener('change', (e) => {
                    this.partyColors['unset'] = e.target.value;
                    this.updateAllBorders();
                });

                // Multi-member district toggle
                document.getElementById('multiMemberToggle').addEventListener('change', (e) => {
                    this.toggleMultiMember(e.target.checked);
                });

                // Add incumbent button
                document.getElementById('addIncumbent').addEventListener('click', () => {
                    this.addIncumbentRow();
                });

                document.getElementById('prPartiesToggle').addEventListener('change', (e) => {
                    this.togglePRParties(e.target.checked);
                });

                document.getElementById('specialElectionToggle').addEventListener('change', (e) => {
                    this.toggleSpecialElection(e.target.checked);
                });

                // Congressional terms controls
                document.getElementById('addTerm').addEventListener('click', () => {
                    this.addCongressionalTerm();
                });

                // Sidebar resizing
                const sidebarResizer = document.getElementById('sidebarResizer');
                const sidebar = document.getElementById('sidebar');
                const mapContainer = document.querySelector('.map-container');
                let isResizing = false;

                sidebarResizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                    e.preventDefault();
                });

                const handleResize = (e) => {
                    if (!isResizing) return;

                    requestAnimationFrame(() => {
                        const containerRect = document.getElementById('mainContent').getBoundingClientRect();
                        const newSidebarWidth = containerRect.right - e.clientX;
                        const minWidth = 300;
                        const maxWidth = containerRect.width * 0.6;

                        if (newSidebarWidth >= minWidth && newSidebarWidth <= maxWidth) {
                            sidebar.style.flex = 'none';
                            sidebar.style.width = newSidebarWidth + 'px';
                        }
                    });
                };

                const stopResize = () => {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleResize);
                    document.removeEventListener('mouseup', stopResize);
                    // Add map invalidation here instead, after resizing is complete
                    this.map.invalidateSize();
                };
            }

            toggleMultiMember(isMultiMember) {
                this.isMultiMember = isMultiMember;
                const addButton = document.getElementById('addIncumbent');
                const singlePartyGroup = document.getElementById('singlePartyGroup');
                const container = document.getElementById('incumbentContainer');

                if (isMultiMember) {
                    // Switching TO multi-member: preserve existing single-member data
                    const existingSingleIncumbent = document.querySelector('.incumbent-input').value;
                    const existingSingleParty = document.getElementById('party').value;
                    const existingSingleMargin = document.getElementById('margin').value;

                    addButton.style.display = 'block';
                    singlePartyGroup.style.display = 'none';
                    document.getElementById('margin').parentElement.style.display = 'none'; // <-- Add this line

                    // Show incumbent party dropdowns and margin inputs
                    document.querySelectorAll('.incumbent-party, .incumbent-margin').forEach(element => {
                        element.style.display = 'block';
                    });

                    // Update first row with existing data
                    const firstRow = container.querySelector('.incumbent-row');
                    if (firstRow) {
                        const firstInput = firstRow.querySelector('.incumbent-input');
                        const firstParty = firstRow.querySelector('.incumbent-party');
                        const firstMargin = firstRow.querySelector('.incumbent-margin');

                        if (firstInput) firstInput.value = existingSingleIncumbent;
                        if (firstParty) firstParty.value = existingSingleParty;
                        if (firstMargin) firstMargin.value = existingSingleMargin;

                        // Ensure first row has margin input if it doesn't exist
                        if (!firstMargin) {
                            const marginInput = document.createElement('input');
                            marginInput.type = 'number';
                            marginInput.className = 'incumbent-margin';
                            marginInput.placeholder = 'Margin %';
                            marginInput.step = '0.1';
                            marginInput.style.marginBottom = '8px';
                            marginInput.value = existingSingleMargin;

                            const partySelect = firstRow.querySelector('.incumbent-party');
                            partySelect.parentNode.insertBefore(marginInput, partySelect.nextSibling);
                        }
                    }

                    // Clear the single margin field since it's now in the first incumbent row
                    document.getElementById('margin').value = '';

                } else {
                    // Switching TO single-member: preserve first incumbent data
                    const firstRow = container.querySelector('.incumbent-row');
                    let firstIncumbentName = '';
                    let firstIncumbentParty = '';
                    let firstIncumbentMargin = '';

                    if (firstRow) {
                        const firstInput = firstRow.querySelector('.incumbent-input');
                        const firstParty = firstRow.querySelector('.incumbent-party');
                        const firstMargin = firstRow.querySelector('.incumbent-margin');
                        
                        if (firstInput) firstIncumbentName = firstInput.value;
                        if (firstParty) firstIncumbentParty = firstParty.value;
                        if (firstMargin) firstIncumbentMargin = firstMargin.value;

                    }

                    addButton.style.display = 'none';
                    singlePartyGroup.style.display = 'block';
                    document.getElementById('margin').parentElement.style.display = 'block'; // <-- Add this line

                    // Hide incumbent party dropdowns and margin inputs for single-member
                    document.querySelectorAll('.incumbent-party, .incumbent-margin').forEach(element => {
                        element.style.display = 'none';
                    });
                    
                    // Remove extra incumbent rows but preserve the first one's value
                    const firstInput = container.querySelector('.incumbent-input');
                    const firstInputValue = firstInput ? firstInput.value : '';

                    const rows = container.querySelectorAll('.incumbent-row');
                    for (let i = 1; i < rows.length; i++) {
                        rows[i].remove();
                    }

                    // Restore the first input value
                    if (firstInput) firstInput.value = firstInputValue;

                    // Transfer first incumbent data to single-member fields
                    if (firstRow) {
                        const firstInput = firstRow.querySelector('.incumbent-input');
                        if (firstInput) firstInput.value = firstIncumbentName;
                    }
                    document.getElementById('party').value = firstIncumbentParty;
                    document.getElementById('margin').value = firstIncumbentMargin;
                }
            }

            addIncumbentRow() {
                const container = document.getElementById('incumbentContainer');
                const existingRows = container.querySelectorAll('.incumbent-row').length;

                // Determine which party options to use
                const partyOptions = this.usePRParties ? `
                    <option value="">Select Party</option>
                    <option value="New Progressive">New Progressive</option>
                    <option value="Popular Democratic">Popular Democratic</option>
                    <option value="Alianza">Alianza</option>
                    <option value="Project Dignity">Project Dignity</option>
                    <option value="Independent">Independent</option>
                ` : `
                    <option value="">Select Party</option>
                    <option value="Democratic">Democratic</option>
                    <option value="Republican">Republican</option>
                    <option value="Independent">Independent</option>
                `;

                const newRow = document.createElement('div');
                newRow.className = 'incumbent-row';
                newRow.setAttribute('data-index', existingRows);
                newRow.innerHTML = `
                    <input type="text" class="incumbent-input" placeholder="Enter incumbent name" style="margin-bottom: 8px;">
                    <select class="incumbent-party" style="margin-bottom: 8px;">
                        ${partyOptions}
                    </select>
                    <input type="number" class="incumbent-margin" placeholder="Margin %" step="0.1" style="margin-bottom: 8px;">
                    <button type="button" class="remove-incumbent btn btn-danger" style="font-size: 11px; padding: 4px 8px; margin-bottom: 8px;">Remove</button>
                `;

                container.appendChild(newRow);

                // Add remove functionality
                newRow.querySelector('.remove-incumbent').addEventListener('click', () => {
                    newRow.remove();
                });
            }

            togglePRParties(usePRParties) {
                const partySelects = document.querySelectorAll('#party, .incumbent-party');

                partySelects.forEach(select => {
                    const currentValue = select.value;

                    if (usePRParties) {
                        // Switch to PR parties
                        select.innerHTML = `
                            <option value="">Select Party</option>
                            <option value="New Progressive">New Progressive</option>
                            <option value="Popular Democratic">Popular Democratic</option>
                            <option value="Alianza">Alianza</option>
                            <option value="Project Dignity">Project Dignity</option>
                            <option value="Independent">Independent</option>
                        `;
                    } else {
                        // Switch back to US parties
                        select.innerHTML = `
                            <option value="">Select Party</option>
                            <option value="Democratic">Democratic</option>
                            <option value="Republican">Republican</option>
                            <option value="Independent">Independent</option>
                        `;
                    }

                    // Try to preserve selection if possible
                    if (select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                });

                // Store the current state for new rows
                this.usePRParties = usePRParties;
                this.updateSpecialElectionParties();

                // Update dropdowns when custom parties are enabled
                if (this.customPartiesEnabled) {
                    this.updateAllPartyDropdowns();
                }
            }

            toggleSpecialElection(hasSpecialElection) {
                const container = document.getElementById('specialElectionContainer');

                if (hasSpecialElection) {
                    container.style.display = 'block';
                    this.updateSpecialElectionParties();

                    // If multi-member is enabled, create multiple special election slots
                    if (this.isMultiMember) {
                        this.updateSpecialElectionSlots();
                    }
                } else {
                    container.style.display = 'none';
                    // Clear special election data
                    container.innerHTML = `
                        <label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbent:</label>
                        <input type="text" id="specialIncumbentInput" placeholder="Enter special election incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                        <select id="specialIncumbentParty" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                            <option value="">Select Party</option>
                            <option value="Democratic">Democratic</option>
                            <option value="Republican">Republican</option>
                            <option value="Independent">Independent</option>
                        </select>
                        <input type="number" id="specialIncumbentMargin" placeholder="Special election margin %" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                    `;
                }
            }

            updateSpecialElectionSlots() {
                const container = document.getElementById('specialElectionContainer');
                const regularIncumbentCount = document.querySelectorAll('.incumbent-row').length;
                
                container.innerHTML = '<label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbents:</label>';

                for (let i = 0; i < regularIncumbentCount; i++) {
                    // Use the same party options logic as other dropdowns
                    const partyOptions = this.getPartyOptionsHTML('');

                    const slotHtml = `
                        <div class="special-incumbent-row" data-index="${i}" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ecf0f1; border-radius: 8px; background: rgba(248, 249, 250, 0.5);">
                            <input type="text" class="special-incumbent-input" placeholder="Special incumbent ${i + 1}" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 12px; margin-bottom: 8px;">
                            <select class="special-incumbent-party" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 12px; margin-bottom: 8px;">
                                ${partyOptions}
                            </select>
                            <input type="number" class="special-incumbent-margin" placeholder="Margin %" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 12px;">
                        </div>
                    `;
                    container.innerHTML += slotHtml;
                }
            }

            updateSpecialElectionParties() {
                const specialPartySelect = document.getElementById('specialIncumbentParty');

                if (this.usePRParties) {
                    specialPartySelect.innerHTML = this.getPartyOptionsHTML('');
                }
            }

            handleColorChange(party, value, pickerElementId) {
                const colorPicker = document.getElementById(pickerElementId);

                if (value === 'custom') {
                    colorPicker.style.display = 'block';
                    colorPicker.click(); // Open color picker immediately
                } else {
                    colorPicker.style.display = 'none';
                    this.partyColors[party] = value;
                    this.updateAllBorders();
                }
            }

            toggleFullscreen() {
                this.isFullscreen = !this.isFullscreen;
                const mainContent = document.getElementById('mainContent');
                const sidebar = document.getElementById('sidebar');
                const sidebarResizer = document.getElementById('sidebarResizer');
                const floatingToggle = document.getElementById('floatingToggle');

                if (this.isFullscreen) {
                    // Hide sidebar completely
                    sidebar.style.display = 'none';
                    sidebarResizer.style.display = 'none';
                    mainContent.classList.add('fullscreen');
                    floatingToggle.innerHTML = '📝';
                    floatingToggle.title = 'Show Editor';
                } else {
                    // Show sidebar
                    sidebar.style.display = 'block';
                    sidebarResizer.style.display = 'block';
                    mainContent.classList.remove('fullscreen');
                    floatingToggle.innerHTML = '🗺️';
                    floatingToggle.title = 'Toggle Fullscreen View';

                    // Reset sidebar to default flex state
                    sidebar.style.flex = '1';
                    sidebar.style.width = '';
                }

                // Trigger map resize after transition
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 300);
            }

            async loadMapFile(files) {
                try {
                    document.getElementById('status').textContent = 'Loading map file...';
                    
                    const file = files[0];
                    if (!file) return;
                    
                    const fileName = file.name.toLowerCase();
                    
                    // Handle GeoJSON files
                    if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                        const text = await file.text();
                        const geojson = JSON.parse(text);
                        this.displayGeoJSON(geojson);
                        return;
                    }
                    
                    // Handle Shapefile formats
                    let shpFile, dbfFile, shxFile;
                    
                    for (let file of files) {
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (ext === 'shp') shpFile = file;
                        else if (ext === 'dbf') dbfFile = file;
                        else if (ext === 'shx') shxFile = file;
                        else if (ext === 'zip') {
                            // Handle zip file
                            const arrayBuffer = await file.arrayBuffer();
                            const geojson = await shp(arrayBuffer);
                            this.displayGeoJSON(geojson);
                            return;
                        }
                    }

                    if (!shpFile) {
                        throw new Error('No supported file format found. Please use GeoJSON (.geojson/.json) or Shapefile (.shp/.zip)');
                    }

                    // Convert shapefile files to array buffers
                    const shpBuffer = await shpFile.arrayBuffer();
                    const dbfBuffer = dbfFile ? await dbfFile.arrayBuffer() : null;
                    
                    // Parse with shpjs
                    const geojson = await shp(shpBuffer, dbfBuffer);
                    this.displayGeoJSON(geojson);
                    
                } catch (error) {
                    console.error('Error loading map file:', error);
                    document.getElementById('status').textContent = 'Error loading map file. Please check file format.';
                    document.getElementById('topBarStatus').textContent = 'Error loading map file. Please check file format.';
                }
            }

            updateAllBorders() {
                if (!this.currentLayer) return;
                
                this.currentLayer.eachLayer((layer) => {
                    const layerUniqueId = layer.uniqueDistrictId;
                    const normalColor = this.getDistrictColor(layerUniqueId);
                    
                    // Check if this is the selected district
                    if (layerUniqueId === this.selectedDistrict) {
                        layer.setStyle({
                            fillColor: normalColor,
                            weight: Math.max(this.borderThickness + 2, 4),
                            color: '#e74c3c', // Keep red for selected districts
                            fillOpacity: this.fillOpacity, // for selected districts
                            opacity: this.borderOpacity, // Add this line
                            dashArray: null,
                            lineCap: 'round',
                            lineJoin: 'round'
                        });
                    } else {
                        layer.setStyle({
                            fillColor: normalColor,
                            weight: this.borderThickness,
                            color: this.getBorderColor(),
                            fillOpacity: this.fillOpacity,  // for non-selected districts
                            opacity: this.borderOpacity // Add this line
                        });
                    }
                });
            }

            getDistrictColor(uniqueId) {
                // Ensure we have valid congressional terms data
                if (!this.congressionalTerms || !this.currentTerm || !this.congressionalTerms[this.currentTerm]) {
                    return this.partyColors['unset'];
                }

                const data = this.congressionalTerms[this.currentTerm].data[uniqueId] || {};
                let party;

                if (data.isMultiMember && data.incumbents && data.incumbents.length > 0) {
                    // Use first incumbent's party for district color
                    party = data.incumbents[0].party;
                } else if (!data.isMultiMember) {
                    party = data.party;
                }

                // Check custom parties first
                if (this.customPartiesEnabled && party && party !== 'Not Set' && party !== '') {
                    const customParty = this.customParties.find(p => p.name === party);
                    if (customParty) {
                        return customParty.color;
                    }
                    // If custom parties are enabled but party not found, return unset color
                    return this.partyColors['unset'];
                }
                
                if (party === 'Democratic') {
                    return this.partyColors['Democratic'];
                } else if (party === 'Republican') {
                    return this.partyColors['Republican'];
                } else if (party === 'Independent') {
                    return this.partyColors['Independent'];
                } else if (party === 'New Progressive') {
                    return this.partyColors['New Progressive'];
                } else if (party === 'Popular Democratic') {
                    return this.partyColors['Popular Democratic'];
                } else if (party === 'Alianza') {
                    return this.partyColors['Alianza'];
                } else if (party === 'Project Dignity') {
                    return this.partyColors['Project Dignity'];
                } else {
                    return this.partyColors['unset'];
                }
            }

            getBorderColor() {
                return this.borderColor === 'black' ? '#2c3e50' : '#ffffff';
            }

            getHoverBorderColor() {
                return this.borderColor === 'black' ? '#ffffff' : '#000000';
            }

            calculateTooltipWidth(incumbentName) {
                if (!incumbentName || incumbentName === 'Not Set') {
                    return 280; // Minimum width for short names
                }

                // Calculate width based on character count
                // Approximately 8-9 pixels per character for the font size we're using
                const baseWidth = 140; // Width for fixed elements (Party, Margin columns)
                const incumbentWidth = Math.max(incumbentName.length * 8.5, 140); // More precise character width
                const totalWidth = baseWidth + incumbentWidth;

                // Constrain between reasonable bounds
                return Math.min(Math.max(totalWidth, 280), 500); // Reduced max width for better appearance
            }

            displayGeoJSON(geojson) {
                if (this.currentLayer) {
                    this.map.removeLayer(this.currentLayer);
                }

                // ADD THESE LINES:
                // Ensure congressional terms are initialized
                if (!this.congressionalTerms) {
                    this.congressionalTerms = {
                        'term_1': {
                            name: '118th Congress',
                            data: {}
                        }
                    };
                    this.currentTerm = 'term_1';
                    this.termCounter = 1;
                }

                // Reset unique ID counter for new map
                this.uniqueIdCounter = 1;

                this.currentLayer = L.geoJSON(geojson, {
                    style: (feature) => {
                        return {
                            fillColor: '#667eea',
                            weight: 2,
                            opacity: 1,
                            color: '#2c3e50',
                            fillOpacity: 0.7,
                            dashArray: null,
                            lineCap: 'butt',
                            lineJoin: 'miter'
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        // Generate a guaranteed unique ID for this district
                        const uniqueId = `DISTRICT_${this.uniqueIdCounter++}`;
                        
                        // Store the unique ID directly on the layer
                        layer.uniqueDistrictId = uniqueId;
                        
                        // Set the initial color based on stored party data
                        const initialColor = this.getDistrictColor(uniqueId);
                        layer.setStyle({
                            fillColor: initialColor,
                            weight: this.borderThickness,
                            opacity: 1,
                            color: this.getBorderColor(),
                            fillOpacity: this.fillOpacity  // <-- Use the variable instead
                        });
                        
                        layer.on({
                            mouseover: (e) => {
                                const layer = e.target;
                                const layerUniqueId = layer.uniqueDistrictId;
                                const currentFillColor = this.getDistrictColor(layerUniqueId);

                                layer.setStyle({
                                    fillColor: currentFillColor,
                                    weight: this.borderThickness + 1.5,
                                    color: this.getHoverBorderColor(),
                                    fillOpacity: this.fillOpacity // <-- Use the variable instead
                                });

                                // Add a temporary inner border effect
                                layer.bringToFront();

                                // IMPORTANT: Always unbind any existing tooltip first
                                layer.unbindTooltip();
                                
                                // Use the stored unique ID from the layer
                                // Using the stored unique ID from the layer (layerUniqueId already declared above)
                                // Safely access congressional terms data with proper fallbacks
                                const currentTermData = this.congressionalTerms && this.currentTerm && this.congressionalTerms[this.currentTerm]
                                    ? this.congressionalTerms[this.currentTerm].data 
                                    : {};
                                const data = currentTermData[layerUniqueId] || {};
                                const districtName = data.districtName || 'Not Set';
                                const margin = data.margin !== null && data.margin !== undefined ? `${data.margin}%` : 'N/A';

                                let incumbentLines = '';
                                let longestName = '';

                                if (data.isMultiMember && data.incumbents && data.incumbents.length > 0) {
                                    // Multi-member district
                                    data.incumbents.forEach((incumbent, index) => {
                                        const name = incumbent.name || 'Not Set';
                                        const party = incumbent.party || 'Not Set';
                                        const margin = incumbent.margin !== null && incumbent.margin !== undefined ? `${incumbent.margin}%` : 'N/A';

                                        if (name.length > longestName.length) {
                                            longestName = name;
                                        }

                                        // Determine party class and display text
                                        let partyClass = 'party-none';
                                        let partyText = 'None';

                                        // Check custom parties first
                                        if (this.customPartiesEnabled && party && party !== 'Not Set') {
                                            const customParty = this.customParties.find(p => p.name === party);
                                            if (customParty) {
                                                partyClass = 'party-custom';
                                                partyText = customParty.abbreviation;

                                                // Create a unique CSS class for this specific party color
                                                const uniqueClass = `party-custom-${customParty.name.replace(/\s+/g, '-').toLowerCase()}`;

                                                // Add dynamic CSS rule if it doesn't exist
                                                if (!document.querySelector(`style[data-party="${customParty.name}"]`)) {
                                                    const style = document.createElement('style');
                                                    style.setAttribute('data-party', customParty.name);
                                                    style.textContent = `.${uniqueClass} { background-color: ${customParty.color} !important; color: white !important; }`;
                                                    document.head.appendChild(style);
                                                }
                                                partyClass = uniqueClass;
                                            }
                                        } else if (party === 'Democratic') {
                                            partyClass = 'party-democratic';
                                            partyText = 'Dem.';
                                        } else if (party === 'Republican') {
                                            partyClass = 'party-republican';
                                            partyText = 'Rep.';
                                        } else if (party === 'Independent') {
                                            partyClass = 'party-independent';
                                            partyText = 'Ind.';
                                        } else if (party === 'New Progressive') {
                                            partyClass = 'party-new-progressive';
                                            partyText = 'PNP';
                                        } else if (party === 'Popular Democratic') {
                                            partyClass = 'party-popular-democratic';
                                            partyText = 'PPD';
                                        } else if (party === 'Alianza') {
                                            partyClass = 'party-alianza';
                                            partyText = 'AdP';
                                        } else if (party === 'Project Dignity') {
                                            partyClass = 'party-project-dignity';
                                            partyText = 'PD';
                                        }

                                        incumbentLines += `
                                            <div class="tooltip-incumbent-line">
                                                <span class="tooltip-incumbent ${partyClass}">${name}</span>
                                                <span class="tooltip-party">${partyText}</span>
                                                <span class="tooltip-margin">${margin}</span>
                                            </div>
                                        `;

                                        // Add separator between incumbent rows (but not after the last one)
                                        if (index < data.incumbents.length - 1) {
                                            incumbentLines += '<div class="tooltip-separator"></div>';
                                        }
                                    });
                                } else {
                                    // Single member district
                                    const incumbent = data.incumbent || 'Not Set';
                                    const party = data.party || 'Not Set';
                                    longestName = incumbent;

                                    // Determine party class and display text
                                    let partyClass = 'party-none';
                                    let partyText = 'None';

                                    
                                    // Check custom parties first
                                    if (this.customPartiesEnabled && party && party !== 'Not Set') {
                                        const customParty = this.customParties.find(p => p.name === party);
                                        if (customParty) {
                                            partyClass = 'party-custom';
                                            partyText = customParty.abbreviation;

                                            // Create a unique CSS class for this specific party color
                                            const uniqueClass = `party-custom-${customParty.name.replace(/\s+/g, '-').toLowerCase()}`;

                                            // Add dynamic CSS rule if it doesn't exist
                                            if (!document.querySelector(`style[data-party="${customParty.name}"]`)) {
                                                const style = document.createElement('style');
                                                style.setAttribute('data-party', customParty.name);
                                                style.textContent = `.${uniqueClass} { background-color: ${customParty.color} !important; color: white !important; }`;
                                                document.head.appendChild(style);
                                            }
                                            partyClass = uniqueClass;
                                        }
                                    } else if (party === 'Democratic') {
                                        partyClass = 'party-democratic';
                                        partyText = 'Dem.';
                                    } else if (party === 'Republican') {
                                        partyClass = 'party-republican';
                                        partyText = 'Rep.';
                                    } else if (party === 'Independent') {
                                        partyClass = 'party-independent';
                                        partyText = 'Ind.';
                                    } else if (party === 'New Progressive') {
                                        partyClass = 'party-new-progressive';
                                        partyText = 'PNP';
                                    } else if (party === 'Popular Democratic') {
                                        partyClass = 'party-popular-democratic';
                                        partyText = 'PPD';
                                     } else if (party === 'Alianza') {
                                        partyClass = 'party-alianza';
                                        partyText = 'AdP';
                                    } else if (party === 'Project Dignity') {
                                        partyClass = 'party-project-dignity';
                                        partyText = 'PD';
                                    }

                                    incumbentLines = `
                                        <div class="tooltip-incumbent-line">
                                            <span class="tooltip-incumbent ${partyClass}">${incumbent}</span>
                                            <span class="tooltip-party">${partyText}</span>
                                            <span class="tooltip-margin">${margin}</span>
                                        </div>
                                    `;
                                }
                                
                                let specialElectionContent = '';
                                if (data.hasSpecialElection && data.specialElection) {
                                    if (data.isMultiMember && data.specialElection.incumbents && data.specialElection.incumbents.length > 0) {
                                        // Multi-member special elections
                                        data.specialElection.incumbents.forEach((specialIncumbent, index) => {
                                            const name = specialIncumbent.name || 'Not Set';
                                            const party = specialIncumbent.party || 'Not Set';
                                            const margin = specialIncumbent.margin !== null && specialIncumbent.margin !== undefined ? `${specialIncumbent.margin}%` : 'N/A';

                                            let partyClass = 'party-none';
                                            let partyText = 'None';

                                            // Check custom parties first
                                            if (this.customPartiesEnabled && party && party !== 'Not Set') {
                                            const customParty = this.customParties.find(p => p.name === party);
                                                if (customParty) {
                                                    partyClass = 'party-custom';
                                                    partyText = customParty.abbreviation;

                                                    // Create a unique CSS class for this specific party color
                                                    const uniqueClass = `party-custom-${customParty.name.replace(/\s+/g, '-').toLowerCase()}`;

                                                    // Add dynamic CSS rule if it doesn't exist
                                                    if (!document.querySelector(`style[data-party="${customParty.name}"]`)) {
                                                        const style = document.createElement('style');
                                                        style.setAttribute('data-party', customParty.name);
                                                        style.textContent = `.${uniqueClass} { background-color: ${customParty.color} !important; color: white !important; }`;
                                                        document.head.appendChild(style);
                                                    }
                                                    partyClass = uniqueClass;
                                                }
                                            } else if (party === 'Democratic') {
                                                partyClass = 'party-democratic';
                                                partyText = 'Dem.';
                                            } else if (party === 'Republican') {
                                                partyClass = 'party-republican';
                                                partyText = 'Rep.';
                                            } else if (party === 'Independent') {
                                                partyClass = 'party-independent';
                                                partyText = 'Ind.';
                                            } else if (party === 'New Progressive') {
                                                partyClass = 'party-new-progressive';
                                                partyText = 'PNP';
                                            } else if (party === 'Popular Democratic') {
                                                partyClass = 'party-popular-democratic';
                                                partyText = 'PPD';
                                            } else if (party === 'Alianza') {
                                                partyClass = 'party-alianza';
                                                partyText = 'AdP';
                                            } else if (party === 'Project Dignity') {
                                                partyClass = 'party-project-dignity';
                                                partyText = 'PD';
                                            }

                                            if (index === 0) {
                                                specialElectionContent += `
                                                    <div class="tooltip-labels">
                                                        <span class="tooltip-label">Spec. Incumbent</span>
                                                        <span class="tooltip-label">Party</span>
                                                        <span class="tooltip-label">Margin</span>
                                                    </div>
                                                    <div class="tooltip-separator"></div>
                                                `;
                                            }

                                            specialElectionContent += `
                                                <div class="tooltip-incumbent-line">
                                                    <span class="tooltip-incumbent ${partyClass}">${name}</span>
                                                    <span class="tooltip-party">${partyText}</span>
                                                    <span class="tooltip-margin">${margin}</span>
                                                </div>
                                            `;
                                        
                                            if (index < data.specialElection.incumbents.length - 1) {
                                                specialElectionContent += '<div class="tooltip-separator"></div>';
                                            }
                                        });
                                    } else {
                                        // Single member special election
                                        const specialIncumbent = data.specialElection.incumbent || 'Not Set';
                                        const specialParty = data.specialElection.party || 'Not Set';
                                        const specialMargin = data.specialElection.margin !== null && data.specialElection.margin !== undefined ? `${data.specialElection.margin}%` : 'N/A';

                                        let specialPartyClass = 'party-none';
                                        let specialPartyText = 'None';

                                        // Check custom parties first
                                        if (this.customPartiesEnabled && specialParty && specialParty !== 'Not Set') {
                                            const customParty = this.customParties.find(p => p.name === specialParty);
                                            if (customParty) {
                                                specialPartyText = customParty.abbreviation;

                                                // Create a unique CSS class for this specific party color
                                                const uniqueClass = `party-custom-${customParty.name.replace(/\s+/g, '-').toLowerCase()}`;

                                                // Add dynamic CSS rule if it doesn't exist
                                                if (!document.querySelector(`style[data-party="${customParty.name}"]`)) {
                                                    const style = document.createElement('style');
                                                    style.setAttribute('data-party', customParty.name);
                                                    style.textContent = `.${uniqueClass} { background-color: ${customParty.color} !important; color: white !important; }`;
                                                    document.head.appendChild(style);
                                                }
                                                specialPartyClass = uniqueClass;
                                            }
                                        } else if (specialParty === 'Democratic') {
                                            specialPartyClass = 'party-democratic';
                                            specialPartyText = 'Dem.';
                                        } else if (specialParty === 'Republican') {
                                            specialPartyClass = 'party-republican';
                                            specialPartyText = 'Rep.';
                                        } else if (specialParty === 'Independent') {
                                            specialPartyClass = 'party-independent';
                                            specialPartyText = 'Ind.';
                                        } else if (specialParty === 'New Progressive') {
                                            specialPartyClass = 'party-new-progressive';
                                            specialPartyText = 'PNP';
                                        } else if (specialParty === 'Popular Democratic') {
                                            specialPartyClass = 'party-popular-democratic';
                                            specialPartyText = 'PPD';
                                        } else if (specialParty === 'Alianza') {
                                            specialPartyClass = 'party-alianza';
                                            specialPartyText = 'AdP';
                                        } else if (specialParty === 'Project Dignity') {
                                            specialPartyClass = 'party-project-dignity';
                                            specialPartyText = 'PD';
                                        }

                                        specialElectionContent = `
                                            <div class="tooltip-labels">
                                                <span class="tooltip-label">Spec. Incumbent</span>
                                                <span class="tooltip-label">Party</span>
                                                <span class="tooltip-label">Margin</span>
                                            </div>
                                            <div class="tooltip-separator"></div>
                                            <div class="tooltip-incumbent-line">
                                                <span class="tooltip-incumbent ${specialPartyClass}">${specialIncumbent}</span>
                                                <span class="tooltip-party">${specialPartyText}</span>
                                                <span class="tooltip-margin">${specialMargin}</span>
                                            </div>
                                        `;
                                    }
                                }

                                const tooltipContent = `
                                    <div class="tooltip-district-name">${districtName}</div>
                                        <div class="tooltip-labels">
                                            <span class="tooltip-label">Incumbent</span>
                                            <span class="tooltip-label">Party</span>
                                            <span class="tooltip-label">Margin</span>
                                        </div>
                                        <div class="tooltip-separator"></div>
                                        ${incumbentLines}
                                        <div class="tooltip-separator"></div>
                                        ${specialElectionContent}
                                    `;
                                
                                // Create a new tooltip each time to ensure fresh data and dynamic width
                                const dynamicWidth = this.calculateTooltipWidth(longestName);
                                layer.bindTooltip(tooltipContent, {
                                    permanent: false,
                                    className: 'tooltip',
                                    sticky: true,
                                    direction: 'bottom',
                                    offset: [0, 20]
                                }).openTooltip();

                                // Force immediate tooltip display
                                layer.openTooltip();

                                // Apply dynamic width after tooltip is created
                                setTimeout(() => {
                                    const tooltipElement = document.querySelector('.leaflet-tooltip');
                                    if (tooltipElement) {
                                        // Force reset all dimensions
                                        tooltipElement.style.width = '';
                                        tooltipElement.style.minWidth = '';
                                        tooltipElement.style.maxWidth = '';

                                        // Force reflow
                                        tooltipElement.offsetHeight;

                                        // Apply new width
                                        tooltipElement.style.width = `${dynamicWidth}px`;
                                    }
                                }, 1);
                            },
                            mouseout: (e) => {
                                const layer = e.target;
                                const layerUniqueId = layer.uniqueDistrictId;
                                const normalColor = this.getDistrictColor(layerUniqueId);
                                const self = this; // Store reference to the class instance
                                
                                // Check if this is the selected district
                                if (layerUniqueId === this.selectedDistrict) {
                                    // Keep selected district styling (red border)
                                    layer.setStyle({
                                        fillColor: normalColor,
                                        weight: Math.max(this.borderThickness + 2, 4),
                                        color: '#e74c3c',
                                        fillOpacity: this.fillOpacity
                                    });
                                } else {
                                    // Reset to normal styling for non-selected districts
                                    layer.setStyle({
                                        fillColor: normalColor,
                                        weight: self.borderThickness,
                                        color: self.getBorderColor(), // This should be the normal border color
                                        fillOpacity: self.fillOpacity  // <-- Use the variable instead
                                    });
                                }

                                // Ensure tooltip is properly closed and unbound
                                layer.closeTooltip();
                                layer.unbindTooltip();
                            },
                            click: (e) => {
                                console.log('District clicked:', e.target.uniqueDistrictId);
                                // Use the stored unique ID from the layer
                                const clickedId = e.target.uniqueDistrictId;
                                if (this.selectedDistrict === clickedId) {
                                    console.log('Deselecting same district');
                                    // De-select if clicking on already selected district
                                    this.deselectDistrict();
                                } else {
                                    console.log('Selecting new district');
                                    // Select the new district
                                    this.selectDistrict(clickedId, e.target);
                                }
                            }
                        });
                    }
                }).addTo(this.map);

                this.map.fitBounds(this.currentLayer.getBounds());
                setTimeout(() => this.preloadTiles(), 500);
                document.getElementById('status').textContent = 'Map file loaded successfully! Click on districts to edit.';
                document.getElementById('topBarStatus').textContent = 'Map file loaded successfully! Click on districts to edit.';
                
                // Ensure map resizes properly
                setTimeout(() => {
                    this.map.invalidateSize();
                }, 100);
                document.getElementById('districtForm').style.display = 'block';
                this.updatePartyCounter();

                // Force update all district colors after map is fully loaded
                setTimeout(() => {
                    this.updateAllBorders();
                }, 200);
            }

            selectDistrict(uniqueId, layer) {
                console.log('=== selectDistrict START ===');
                console.log('uniqueId passed in:', uniqueId);
                console.log('Current selectedDistrict before setting:', this.selectedDistrict);

                console.log('uniqueId:', uniqueId);
                console.log('Current term:', this.currentTerm);
                console.log('Data for this district:', this.congressionalTerms[this.currentTerm].data[uniqueId]);

                console.log('=== updateDistrictData called ===');
                console.log('selectedDistrict:', this.selectedDistrict);
                console.log('Event target that may have triggered this:', document.activeElement);
                
                // Prevent double selection of the same district
                if (this.selectedDistrict === uniqueId) {
                    console.log('Already selected, skipping');
                    return;
                }
                
                // ADD THIS: Clear previous selection first
                if (this.selectedDistrict && this.currentLayer) {
                    this.currentLayer.eachLayer((l) => {
                        if (l.uniqueDistrictId === this.selectedDistrict) {
                            const normalColor = this.getDistrictColor(this.selectedDistrict);
                            l.setStyle({
                                fillColor: normalColor,
                                weight: this.borderThickness,
                                color: this.getBorderColor(),
                                fillOpacity: this.fillOpacity
                            });
                        }
                    });
                }

                // Rest of the existing selectDistrict method continues here...
                this.selectedDistrict = uniqueId;
                console.log('Selected district set to:', this.selectedDistrict);

                // Use the new reset method to ensure clean state
                this.resetFormToDefault();

                // CRITICAL: Reset all toggle states immediately after checkbox reset
                this.toggleMultiMember(false);
                console.log('After toggleMultiMember - input value:', document.querySelector('.incumbent-input')?.value);

                this.togglePRParties(false);
                console.log('After togglePRParties - input value:', document.querySelector('.incumbent-input')?.value);

                this.toggleSpecialElection(false);
                console.log('After toggleSpecialElection - input value:', document.querySelector('.incumbent-input')?.value);

                // CRITICAL: Force clear special election state BEFORE loading any district data
                this.toggleSpecialElection(false);

                document.getElementById('selectedDistrict').textContent = `Selected`;
                document.getElementById('uniqueIdDisplay').textContent = `Unique ID: ${uniqueId}`;
                // Show form immediately when district is selected
                document.getElementById('districtForm').style.display = 'block'; // ADD THIS LINE (at the end, no have it here instead)
                
                // Load existing data if available
                const data = this.congressionalTerms[this.currentTerm].data[uniqueId] || {};
                console.log('Loaded district data:', data);
                console.log('Is multi-member?', data.isMultiMember);
                console.log('Incumbent data:', data.incumbent);
                console.log('Incumbents array:', data.incumbents);
                console.log('selectDistrict loading data:', data);
                console.log('uniqueId being used:', uniqueId);
                console.log('this.currentTerm:', this.currentTerm);
                console.log('Loaded data for district:', data);
                console.log('Incumbent in data:', data.incumbent);
                document.getElementById('districtName').value = data.districtName || '';

                // Declare container variable once
                const incumbentContainer = document.getElementById('incumbentContainer');

                // Load incumbent data
                if (data.isMultiMember && data.incumbents && data.incumbents.length > 0) {
                    // Set multi-member state BEFORE calling toggleMultiMember
                    this.isMultiMember = true;
                    document.getElementById('multiMemberToggle').checked = true;
                    this.toggleMultiMember(true);

                    incumbentContainer.innerHTML = ''; // Clear existing

                    data.incumbents.forEach((incumbent, index) => {
                        const partyOptions = this.usePRParties ? `
                            <option value="">Select Party</option>
                            <option value="New Progressive" ${incumbent.party === 'New Progressive' ? 'selected' : ''}>New Progressive</option>
                            <option value="Popular Democratic" ${incumbent.party === 'Popular Democratic' ? 'selected' : ''}>Popular Democratic</option>
                            <option value="Alianza" ${incumbent.party === 'Alianza' ? 'selected' : ''}>Alianza</option>
                            <option value="Project Dignity" ${incumbent.party === 'Project Dignity' ? 'selected' : ''}>Project Dignity</option>
                            <option value="Independent" ${incumbent.party === 'Independent' ? 'selected' : ''}>Independent</option>
                        ` : `
                            <option value="">Select Party</option>
                            <option value="Democratic" ${incumbent.party === 'Democratic' ? 'selected' : ''}>Democratic</option>
                            <option value="Republican" ${incumbent.party === 'Republican' ? 'selected' : ''}>Republican</option>
                            <option value="Independent" ${incumbent.party === 'Independent' ? 'selected' : ''}>Independent</option>
                        `;

                        const newRow = document.createElement('div');
                        newRow.className = 'incumbent-row';
                        newRow.setAttribute('data-index', index);
                        newRow.innerHTML = `
                            <input type="text" class="incumbent-input" placeholder="Enter incumbent name" style="margin-bottom: 8px;" value="${incumbent.name || ''}">
                            <select class="incumbent-party" style="margin-bottom: 8px;">
                                ${partyOptions}
                            </select>
                            <input type="number" class="incumbent-margin" placeholder="Margin %" step="0.1" style="margin-bottom: 8px;" value="${incumbent.margin || ''}">
                            ${index > 0 ? '<button type="button" class="remove-incumbent btn btn-danger" style="font-size: 11px; padding: 4px 8px; margin-bottom: 8px;">Remove</button>' : ''}
                        `;
                        incumbentContainer.appendChild(newRow);

                        // Add remove functionality for additional rows
                        if (index > 0) {
                            newRow.querySelector('.remove-incumbent').addEventListener('click', () => {
                                newRow.remove();
                            });
                        }
                    });
                } else {
                    // Single member district
                    this.isMultiMember = false;
                    document.getElementById('multiMemberToggle').checked = false;
                    this.toggleMultiMember(false);

                    // Load single incumbent data properly
                    const firstInput = document.querySelector('.incumbent-input');
                    console.log('First input element:', firstInput);
                    console.log('Setting value to:', data.incumbent || '');
                    if (firstInput) {
                        firstInput.value = data.incumbent || '';
                        console.log('Value after setting:', firstInput.value);
                    }
                    
                    // Load single party data
                    document.getElementById('party').value = data.party || '';
                    document.getElementById('margin').value = data.margin || ''; // <-- Add this line

                    // Update dropdowns to ensure custom parties are available
                    this.updateAllPartyDropdowns();
                }

                console.log('After loading - first input value:', document.querySelector('.incumbent-input').value);

                // Set PR parties toggle based on stored data (first)
                document.getElementById('prPartiesToggle').checked = data.usePRParties || false;
                this.togglePRParties(data.usePRParties || false);

                // Highlight selected district
                // Reset all districts to normal styling first
                if (this.currentLayer) {
                    this.currentLayer.eachLayer((l) => {
                        const layerUniqueId = l.uniqueDistrictId;
                        const normalColor = this.getDistrictColor(layerUniqueId);
                        l.setStyle({
                            fillColor: normalColor,
                            weight: this.borderThickness,
                            color: this.getBorderColor(),
                            fillOpacity: this.fillOpacity  // <-- Use the variable instead
                        });
                    });
                }
                
                layer.setStyle({
                    weight: Math.max(this.borderThickness + 2, 4),
                    color: '#e74c3c',
                    fillOpacity: this.fillOpacity,  // <-- Use normal opacity instead
                    lineCap: 'round',
                    lineJoin: 'round'
                });

                // Auto-zoom to selected district
                if (this.autoZoomEnabled) {
                    this.map.fitBounds(layer.getBounds());
                }

                // ADD THE SPECIAL ELECTION CODE HERE - AFTER THE CLOSING BRACE (old comment)
                // Load special election data (old comment)
                // Load special election data - moved to end to prevent state conflicts
                if (data.hasSpecialElection) {
                    document.getElementById('specialElectionToggle').checked = true;
                    this.toggleSpecialElection(true);
                } else {
                    document.getElementById('specialElectionToggle').checked = false;
                    // Special election already cleared above, no need to call toggleSpecialElection(false) again
                } // Don't call toggleSpecialElection(false) here since we already cleared it above (old comment)

                if (data.specialElection) {
                    if (data.isMultiMember && data.specialElection.incumbents) {
                        // Handle multi-member special elections - the toggleSpecialElection will create the slots
                        setTimeout(() => {
                            const specialRows = document.querySelectorAll('.special-incumbent-row');
                            data.specialElection.incumbents.forEach((incumbent, index) => {
                                if (specialRows[index]) {
                                    specialRows[index].querySelector('.special-incumbent-input').value = incumbent.name || '';
                                    specialRows[index].querySelector('.special-incumbent-party').value = incumbent.party || '';
                                    specialRows[index].querySelector('.special-incumbent-margin').value = incumbent.margin || '';
                                }
                            });
                        }, 50);
                    } else {
                        // Handle single-member special elections
                        document.getElementById('specialIncumbentInput').value = data.specialElection.incumbent || '';
                        document.getElementById('specialIncumbentParty').value = data.specialElection.party || '';
                        document.getElementById('specialIncumbentMargin').value = data.specialElection.margin || '';
                    }
                }

                // Choose between modal or sidebar based on fullscreen mode
                if (this.isFullscreen) {
                    this.showDistrictEditorModal(uniqueId);
                } else {
                    // Show sidebar form when not in fullscreen
                    document.getElementById('districtForm').style.display = 'block';
                }

                console.log('=== SELECTDISTRICT END ===');
                console.log('selectedDistrict after setting:', this.selectedDistrict);
                console.log('First input value at end:', document.querySelector('.incumbent-input')?.value);
            }

            showDistrictEditorModal(uniqueId) {
                const data = this.congressionalTerms[this.currentTerm].data[uniqueId] || {};
                console.log('Modal data loaded:', data);
                console.log('Modal incumbent value:', data.incumbent);

                const content = `
                    <div class="district-info" style="margin-bottom: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <strong>Selected District ID: </strong><span>Selected</span>
                        <div class="unique-id-display" style="font-family: monospace; background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 5px; color: #667eea;">
                            Unique ID: ${uniqueId}
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #34495e; font-weight: 500;">District Name/Number:</label>
                        <input type="text" id="modalDistrictName" value="${data.districtName || ''}" placeholder="e.g., ME-2, California 7th, etc." style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.9);">
                    </div>

                    <!-- Toggle Options -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="modalMultiMember" ${data.isMultiMember ? 'checked' : ''} style="width: auto; margin: 0;">
                            Multi-member district
                        </label>

                        <label id="modalPRPartiesLabel" style="display: ${this.customPartiesEnabled ? 'none' : 'flex'}; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="modalPRParties" ${data.usePRParties ? 'checked' : ''} style="width: auto; margin: 0;">
                            Use Puerto Rican parties
                        </label>

                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="modalSpecialElection" ${data.hasSpecialElection ? 'checked' : ''} style="width: auto; margin: 0;">
                            Include special election
                        </label>
                    </div>

                    <!-- Incumbent Section -->
                    <div id="modalIncumbentSection">
                        <div id="modalIncumbentSection">
                            <label style="display: block; margin-bottom: 8px; color: #34495e; font-weight: 500;">Congressional Incumbent(s):</label>
                            <div id="modalIncumbentContainer">
                                <input type="text" id="modalSingleIncumbent" placeholder="Enter incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                            </div>
                            <button type="button" id="modalAddIncumbent" style="display: none; margin-top: 10px; font-size: 12px; padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 25px; cursor: pointer;">+ Add Incumbent</button>
                        </div>
                    
                    <!-- Single District Controls -->
                        <div id="modalSingleControls" style="margin-top: 20px;">
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #34495e; font-weight: 500;">Election Margin (%):</label>
                                <input type="number" id="modalMargin" value="${data.margin || ''}" step="0.1" placeholder="Enter margin (e.g., 5.2)" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.9);">
                            </div>

                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #34495e; font-weight: 500;">Party Control:</label>
                                <select id="modalParty" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.9);">
                                    <option value="">Select Party</option>
                                    <option value="Democratic" ${data.party === 'Democratic' ? 'selected' : ''}>Democratic</option>
                                    <option value="Republican" ${data.party === 'Republican' ? 'selected' : ''}>Republican</option>
                                    <option value="Independent" ${data.party === 'Independent' ? 'selected' : ''}>Independent</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Special Election Section -->
                        <div id="modalSpecialElectionContainer" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ecf0f1; border-radius: 8px; background: rgba(248, 249, 250, 0.5);">
                            <div id="modalSpecialElectionContainer" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ecf0f1; border-radius: 8px; background: rgba(248, 249, 250, 0.5);">
                                <label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbent:</label>
                                <input type="text" id="modalSpecialIncumbent" placeholder="Enter special election incumbent name" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; margin-bottom: 8px; background: white;">
                                <select id="modalParty" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; background: rgba(255, 255, 255, 0.9);">
                                    ${this.getPartyOptionsHTML(data.party || '')}
                                </select>
                                <input type="number" id="modalSpecialMargin" placeholder="Special election margin %" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; background: white;">
                            </div>
                        </div>

                        <button id="modalUpdateDistrict" class="btn" style="margin-top: 30px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; width: 100%;">Update District</button>
                    `;

                this.showModal('District Editor', content);

                // Initialize the form based on current data
                console.log('About to initialize modal form with data:', data);
                this.initializeModalDistrictForm(data);
                console.log('Modal incumbent input after initialization:', document.getElementById('modalSingleIncumbent')?.value);

                // Add a delay and check again
                setTimeout(() => {
                    console.log('Modal incumbent input after 100ms delay:', document.getElementById('modalSingleIncumbent')?.value);
                }, 100);

                // Bind all the modal district form events
                this.bindModalDistrictEvents(uniqueId);

                // Bind the update button
                document.getElementById('modalUpdateDistrict').addEventListener('click', () => {
                    if (!this.selectedDistrict) {
                        console.error('No district selected for modal update');
                        return;
                    }
                    this.updateDistrictDataFromModal();
                    this.hideModal();
                });
            }


            deselectDistrict() {
                // Hide form fields when no district is selected - ADD THIS SECTION
                // Hide form fields immediately when deselecting
                // Hide form immediately
                document.getElementById('districtForm').style.display = 'none';

                this.selectedDistrict = null;
                document.getElementById('selectedDistrict').textContent = 'None';
                document.getElementById('uniqueIdDisplay').textContent = '';

                // Use the new reset method to ensure clean state
                this.resetFormToDefault();

                // Clear form fields
                document.getElementById('districtName').value = '';
                document.getElementById('margin').value = '';
                document.getElementById('party').value = '';
                document.getElementById('multiMemberToggle').checked = false;
                document.getElementById('prPartiesToggle').checked = false;
                this.usePRParties = false;
                this.isMultiMember = false; // ADD THIS LINE
                this.toggleMultiMember(false); // Don't reset this.usePRParties here - it should be set based on district data
                document.getElementById('specialElectionToggle').checked = false;
                // Force clear special election container completely

                // Remove highlight from all districts
                if (this.currentLayer) {
                    this.currentLayer.eachLayer((l) => {
                        const layerUniqueId = l.uniqueDistrictId;
                        const normalColor = this.getDistrictColor(layerUniqueId);
                        l.setStyle({
                            fillColor: normalColor,
                            weight: this.borderThickness,
                            color: this.getBorderColor(),
                            fillOpacity: this.fillOpacity
                        });
                    });
                }

                document.getElementById('status').textContent = 'District deselected';
            }

            resetFormToDefault() {
                // Reset all instance variables first
                this.isMultiMember = false;
                this.usePRParties = false;

                // Reset all checkboxes
                document.getElementById('multiMemberToggle').checked = false;
                document.getElementById('prPartiesToggle').checked = false;
                document.getElementById('specialElectionToggle').checked = false;

                // Clear all form inputs
                document.getElementById('districtName').value = '';
                document.getElementById('margin').value = '';
                document.getElementById('party').value = '';

                // Completely rebuild incumbent container with fresh HTML and event binding
                // Don't rebuild the container - just clear values
                const container = document.getElementById('incumbentContainer');
                const inputs = container.querySelectorAll('.incumbent-input');
                const selects = container.querySelectorAll('.incumbent-party');
                const margins = container.querySelectorAll('.incumbent-margin');

                inputs.forEach(input => input.value = '');
                selects.forEach(select => select.value = '');
                margins.forEach(margin => margin.value = '');

                // Remove extra rows beyond the first one
                const rows = container.querySelectorAll('.incumbent-row');
                for (let i = 1; i < rows.length; i++) {
                    rows[i].remove();
                }

                // Reset special election container to default HTML
                const specialContainer = document.getElementById('specialElectionContainer');
                specialContainer.style.display = 'none';
                specialContainer.innerHTML = `
                    <label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbent:</label>
                    <input type="text" id="specialIncumbentInput" placeholder="Enter special election incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                    <select id="specialIncumbentParty" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                        <option value="">Select Party</option>
                        <option value="Democratic">Democratic</option>
                        <option value="Republican">Republican</option>
                        <option value="Independent">Independent</option>
                    </select>
                    <input type="number" id="specialIncumbentMargin" placeholder="Special election margin %" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                `;

                // Reset visibility states
                document.getElementById('addIncumbent').style.display = 'none';
                document.getElementById('singlePartyGroup').style.display = 'block';
                document.getElementById('margin').parentElement.style.display = 'block';
            }

            updateDistrictData() {
                console.log('=== updateDistrictData START ===');
                console.log('this.selectedDistrict:', this.selectedDistrict);
                console.log('Call stack:', new Error().stack);
                console.trace();  // This will show the call stack
                
                console.log('updateDistrictData called, selectedDistrict:', this.selectedDistrict);
                console.log('updateDistrictData called');
                console.log('this.selectedDistrict:', this.selectedDistrict);
                console.log('Event target that may have triggered this:', document.activeElement);
                if (!this.selectedDistrict || this.selectedDistrict === 'undefined' || this.selectedDistrict === undefined) {
                    console.error('Invalid district selected:', this.selectedDistrict);
                    alert('Please select a district first');
                    return; // Stop execution here
                }

                const districtName = document.getElementById('districtName').value.trim();
                const margin = parseFloat(document.getElementById('margin').value);

                // Collect incumbent data
                let incumbentData;
                if (this.isMultiMember) {
                    incumbentData = [];
                    const rows = document.querySelectorAll('.incumbent-row');
                    rows.forEach(row => {
                        const name = row.querySelector('.incumbent-input').value.trim();
                        const party = row.querySelector('.incumbent-party').value;
                        const marginInput = row.querySelector('.incumbent-margin');
                        const incumbentMargin = marginInput ? parseFloat(marginInput.value) : null;

                        if (name) {
                            incumbentData.push({ 
                                name,
                                party,
                                margin: isNaN(incumbentMargin) ? null : incumbentMargin
                            });
                        }
                    });

                    // Get special election data
                    let specialElectionData = null;
                    if (document.getElementById('specialElectionToggle').checked) {
                        if (this.isMultiMember) {
                            // Multi-member special elections
                            const specialRows = document.querySelectorAll('.special-incumbent-row');
                            const specialIncumbents = [];
                            specialRows.forEach(row => {
                                const name = row.querySelector('.special-incumbent-input').value.trim();
                                const party = row.querySelector('.special-incumbent-party').value;
                                const margin = parseFloat(row.querySelector('.special-incumbent-margin').value);

                                if (name) {
                                    specialIncumbents.push({
                                        name,
                                        party,
                                        margin: isNaN(margin) ? null : margin
                                    });
                                }
                            });

                            if (specialIncumbents.length > 0) {
                                specialElectionData = { incumbents: specialIncumbents };
                            }
                        } else {
                            // Single member special election
                            const specialIncumbent = document.getElementById('specialIncumbentInput').value.trim();
                            const specialParty = document.getElementById('specialIncumbentParty').value;
                            const specialMargin = parseFloat(document.getElementById('specialIncumbentMargin').value);

                            if (specialIncumbent) {
                                specialElectionData = {
                                    incumbent: specialIncumbent,
                                    party: specialParty,
                                    margin: isNaN(specialMargin) ? null : specialMargin
                                };
                            }
                        }
                    }

                    if (!this.selectedDistrict) {
                        console.error('No district selected for update');
                        return;
                    }

                    // Add this right before the multi-member save
                    console.log('About to save data for district:', this.selectedDistrict);
                    if (!this.selectedDistrict || this.selectedDistrict === undefined) {
                        console.error('Attempting to save with invalid district ID, aborting');
                        return;
                    }

                    this.congressionalTerms[this.currentTerm].data[this.selectedDistrict] = {
                        districtName: districtName,
                        incumbents: incumbentData,
                        isMultiMember: true,
                        usePRParties: this.usePRParties,  // Add this line
                        hasSpecialElection: document.getElementById('specialElectionToggle').checked,
                        specialElection: specialElectionData
                    };

                } else {
                    const singleIncumbent = document.querySelector('.incumbent-input').value.trim();
                    const party = document.getElementById('party').value;

                    // Get special election data
                    const specialIncumbent = document.getElementById('specialIncumbentInput').value.trim();
                    const specialParty = document.getElementById('specialIncumbentParty').value;
                    const specialMargin = parseFloat(document.getElementById('specialIncumbentMargin').value);

                    // Add this check before saving district data
                    if (!this.selectedDistrict) {
                        console.error('No valid district selected, aborting save');
                        return;
                    }

                    // Add this right before the single-member save 
                    console.log('About to save data for district:', this.selectedDistrict);
                    if (!this.selectedDistrict || this.selectedDistrict === undefined) {
                        console.error('Attempting to save with invalid district ID, aborting');
                        return;
                    }

                    this.congressionalTerms[this.currentTerm].data[this.selectedDistrict] = {
                        districtName: districtName,
                        incumbent: singleIncumbent,
                        margin: isNaN(margin) ? null : margin,
                        party: party,
                        isMultiMember: false,
                        usePRParties: this.usePRParties,  // Add this line
                        hasSpecialElection: document.getElementById('specialElectionToggle').checked,
                        specialElection: document.getElementById('specialElectionToggle').checked ? {
                            incumbent: specialIncumbent,
                            party: specialParty,
                            margin: isNaN(specialMargin) ? null : specialMargin
                        } : null
                    };
                }

                // Update the visual appearance of the district
                this.updateDistrictAppearance();

                const displayName = districtName || 'Unnamed District';
                document.getElementById('status').textContent = `Updated ${displayName}`;
                // Remove the first updatePartyCounter() call here

                // Add this line at the end of updateDistrictData()
                document.getElementById('topBarStatus').textContent = `Updated ${displayName}`;
            }

            updateDistrictAppearance() {
                if (!this.selectedDistrict || !this.currentLayer) return;

                // Find the layer with the selected district ID and update its color
                this.currentLayer.eachLayer((layer) => {
                    if (layer.uniqueDistrictId === this.selectedDistrict) {
                        const newColor = this.getDistrictColor(this.selectedDistrict);
                        layer.setStyle({
                            fillColor: newColor,
                            weight: Math.max(this.borderThickness + 2, 4), // Keep it highlighted since it's selected
                            color: '#e74c3c',
                            fillOpacity: this.fillOpacity  // <-- Use normal opacity instead
                        });
                    }
                });

                // Add this at the end of updateDistrictAppearance()
                this.updatePartyCounter();
            }

            updatePartyCounter() {
                console.log('=== updatePartyCounter START ===');
                console.log('Current term:', this.currentTerm);
                console.log('Congressional terms object:', this.congressionalTerms);

                console.log('Current term:', this.currentTerm);
                console.log('Term data:', this.congressionalTerms[this.currentTerm].data);
                console.log('Object values:', Object.values(this.congressionalTerms[this.currentTerm].data));

                if (!this.congressionalTerms || !this.currentTerm || !this.congressionalTerms[this.currentTerm]) {
                    console.log('EARLY EXIT: Missing congressional terms data');
                    document.getElementById('partyCounter').style.display = 'none';
                    return;
                }

                const termData = this.congressionalTerms[this.currentTerm].data;
                console.log('Term data:', termData);
                console.log('Number of districts with data:', Object.keys(termData).length);

                let demCount = 0;
                let repCount = 0;
                let indCount = 0;

                // Count districts by party, excluding unset and PR parties
                // Count seats by party (each incumbent = 1 seat)
                // Count seats by party correctly
                Object.entries(termData).forEach(([districtId, district]) => {
                    // Skip districts with invalid IDs
                    if (!districtId || districtId === 'undefined' || districtId === undefined) {
                        console.log('Skipping district with invalid ID:', districtId);
                        return;
                    }
                    console.log('Processing district:', district);
                    // Handle multi-member districts
                    if (district.isMultiMember && district.incumbents && district.incumbents.length > 0) {
                        // Count each incumbent individually
                        // Multi-member: count each incumbent individually
                        district.incumbents.forEach(incumbent => {
                            console.log('Multi-member incumbent:', incumbent);
                            if (incumbent.party === 'Democratic') {
                                demCount++;
                                console.log('Dem count now:', demCount);
                            } else if (incumbent.party === 'Republican') {
                                repCount++;
                                console.log('Rep count now:', repCount);
                            } else if (incumbent.party === 'Independent') {
                                indCount++;
                            }
                        });
                    } else if (!district.isMultiMember && district.party) {
                        console.log('Single-member district party:', district.party);
                        // Single member district - count once
                        // Single-member: count the district once based on party
                        // Single-member: count based on the incumbent's party (from the incumbent field)
                        // This assumes you're storing the party in district.party for single members
                        if (district.party === 'Democratic') {
                            demCount++;
                            console.log('Dem count now:', demCount);
                        } else if (district.party === 'Republican') {
                            repCount++;
                            console.log('Rep count now:', repCount);
                        } else if (district.party === 'Independent') {
                            indCount++;
                        }
                    }
                    // Districts with no party set are not counted
                });

                // Show counter when map is loaded
                // Only show counter when map is loaded AND user has it enabled
                if (this.currentLayer) {
                    // Check if party counter should be displayed based on user setting
                    const shouldShow = document.getElementById('partyCounter').style.display !== 'none';

                    if (shouldShow) {
                        document.getElementById('partyCounter').style.display = 'block';
                    }

                    // Update numbers
                    document.querySelector('.dem-count').textContent = demCount;
                    document.querySelector('.rep-count').textContent = repCount;

                    // Calculate total seats and majority requirement
                    const totalSeats = demCount + repCount + indCount;
                    const majorityNeeded = Math.floor(totalSeats / 2) + 1;

                    // Update majority number display
                    document.querySelector('.majority-number').textContent = totalSeats > 0 ? majorityNeeded : '';

                    // Show/hide majority indicators
                    const demIndicator = document.querySelector('.dem-indicator');
                    const repIndicator = document.querySelector('.rep-indicator');

                    demIndicator.classList.remove('visible');
                    repIndicator.classList.remove('visible');

                    if (demCount >= majorityNeeded && majorityNeeded > 0) {
                        demIndicator.classList.add('visible');
                    } else if (repCount >= majorityNeeded && majorityNeeded > 0) {
                        repIndicator.classList.add('visible');
                    }

                    // Calculate percentages for the bar based on total assigned seats
                    if (totalSeats > 0) {
                        const demPercent = (demCount / totalSeats) * 100;
                        const indPercent = (indCount / totalSeats) * 100;
                        const repPercent = (repCount / totalSeats) * 100;

                        document.querySelector('.dem-section').style.width = demPercent + '%';
                        document.querySelector('.ind-section').style.width = indPercent + '%';
                        document.querySelector('.rep-section').style.width = repPercent + '%';
                    } else {
                        // No seats assigned yet - show empty bar
                        document.querySelector('.dem-section').style.width = '0%';
                        document.querySelector('.ind-section').style.width = '0%';
                        document.querySelector('.rep-section').style.width = '0%';
                    }
                } else {
                    document.getElementById('partyCounter').style.display = 'none';
                }
            }

            getTotalDistrictCount() {
                if (!this.currentLayer) return 0;
                let count = 0;
                this.currentLayer.eachLayer(() => count++);
                return count;
            }
            
            saveMapData() {
                const data = {
                    congressionalTerms: this.congressionalTerms,
                    currentTerm: this.currentTerm,
                    timestamp: new Date().toISOString()
                };

                // Only add custom parties data if it's actually being used
                if (this.customPartiesEnabled || this.customParties.length > 0) {
                    data.customPartiesEnabled = this.customPartiesEnabled;
                    data.customParties = this.customParties;
                }

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `congressional_map_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                document.getElementById('status').textContent = 'Map data saved successfully!';
                document.getElementById('topBarStatus').textContent = 'Map data saved successfully!';
            }

            async loadMapData(file) {
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    // Check if this is an old format save file
                    if (data.districtData && !data.congressionalTerms) {
                        // Old format - convert to new format
                        this.congressionalTerms = {
                            'term_1': {
                                name: '118th Congress',
                                data: data.districtData
                            }
                        };
                        this.currentTerm = 'term_1';
                        this.termCounter = 1;
                    } else {
                        // New format
                        this.congressionalTerms = data.congressionalTerms || this.congressionalTerms;
                        this.currentTerm = data.currentTerm || this.currentTerm;
                        this.termCounter = Math.max(...Object.keys(this.congressionalTerms).map(k => parseInt(k.split('_')[1]))) || 1;

                        // Load custom parties data with fallbacks for backwards compatibility
                        this.customPartiesEnabled = data.customPartiesEnabled || false;
                        this.customParties = data.customParties || [];
                        this.updatePRPartiesVisibility(); // Add this line here
                    }

                        this.renderTabs();
                        this.updatePartyCounter();
                        document.getElementById('status').textContent = 'Map data loaded successfully!';
                    } catch (error) {
                        console.error('Error loading map data:', error);
                        document.getElementById('status').textContent = 'Error loading map data';
                    
                    }
                }

            clearMap() {
                this.showConfirmDialog('Are you sure you want to clear all data? This cannot be undone.', () => {
                    if (this.currentLayer) {
                        this.map.removeLayer(this.currentLayer);
                        this.currentLayer = null;
                    }
                    
                    this.congressionalTerms = {
                        'term_1': {
                            name: '118th Congress',
                            data: {}
                        }
                    };
                    this.currentTerm = 'term_1';
                    this.termCounter = 1;

                    this.selectedDistrict = null;
                    this.uniqueIdCounter = 1;
                    
                    document.getElementById('selectedDistrict').textContent = 'None';
                    document.getElementById('uniqueIdDisplay').textContent = '';
                    document.getElementById('districtName').value = '';
                    document.getElementById('incumbent').value = '';
                    document.getElementById('margin').value = '';
                    document.getElementById('party').value = '';
                    document.getElementById('districtForm').style.display = 'none';
                    document.getElementById('status').textContent = 'Map cleared. Load a GeoJSON or Shapefile to begin.';
                    this.updatePartyCounter();
                });
            }

            addCongressionalTerm() {
                this.termCounter++;
                const termId = `term_${this.termCounter}`;
                this.congressionalTerms[termId] = {
                    name: `${117 + this.termCounter}th Congress`,
                    data: {}
                };

                this.renderTabs();
                this.switchToTerm(termId);
            }

            renderTabs() {
                const tabsHeader = document.querySelector('.tabs-header');
                tabsHeader.innerHTML = '';

                Object.keys(this.congressionalTerms).forEach(termId => {
                    const term = this.congressionalTerms[termId];
                    const tab = document.createElement('div');
                    tab.className = `tab ${termId === this.currentTerm ? 'active' : ''}`;
                    tab.setAttribute('data-term', termId);

                    tab.innerHTML = `
                        <span class="tab-name">${term.name}</span>
                        <span class="tab-edit-icon" style="margin-left: 6px; opacity: 0.7; cursor: pointer; font-size: 12px;">✏️</span>
                        <input type="text" class="tab-name-input" value="${term.name}" style="display: none;">
                        ${Object.keys(this.congressionalTerms).length > 1 ? '<span class="tab-close">×</span>' : ''}
                    `;

                    // Tab click to switch
                    tab.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('tab-close') && !e.target.classList.contains('tab-name-input')) {
                            this.switchToTerm(termId);
                        }
                    });

                    // Tab name click to edit
                    const tabNameSpan = tab.querySelector('.tab-name');
                    const nameInput = tab.querySelector('.tab-name-input');
                    const editIcon = tab.querySelector('.tab-edit-icon');

                    editIcon.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent tab switching
                        tabNameSpan.style.display = 'none';
                        editIcon.style.display = 'none';
                        nameInput.style.display = 'inline';
                        nameInput.focus();
                        nameInput.select(); // Select all text for easy editing
                    });

                    // Prevent text selection on the tab name span
                    tabNameSpan.style.userSelect = 'none';
                    tabNameSpan.style.webkitUserSelect = 'none';
                    tabNameSpan.style.mozUserSelect = 'none';

                    // Tab name input handlers
                    nameInput.addEventListener('blur', (e) => {
                        this.congressionalTerms[termId].name = e.target.value;
                        tabNameSpan.textContent = e.target.value;
                        nameInput.style.display = 'none';
                        tabNameSpan.style.display = 'inline';
                        editIcon.style.display = 'inline'; // Show the edit icon again
                    });

                    nameInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            nameInput.blur(); // Trigger the blur event to save
                        }
                        if (e.key === 'Escape') {
                            nameInput.value = this.congressionalTerms[termId].name; // Restore original value
                            nameInput.blur();
                        }
                    });
                    
                    // Tab close
                    const closeBtn = tab.querySelector('.tab-close');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.removeCongressionalTerm(termId);
                        });
                    }

                    tabsHeader.appendChild(tab);
                });
            }

            switchToTerm(termId) {
                // Save current form data to current term before switching
                if (this.selectedDistrict) {
                    this.saveCurrentFormData();
                }

                this.currentTerm = termId;
                this.renderTabs();

                // Load data for the new term
                if (this.selectedDistrict) {
                    this.loadFormDataForTerm();
                    this.updateDistrictAppearance();
                }

                // Update all district appearances for new term
                this.updateAllBorders();
                this.updatePartyCounter();
            }

            removeCongressionalTerm(termId) {
                if (Object.keys(this.congressionalTerms).length <= 1) {
                    alert('Cannot remove the last congressional term');
                    return;
                }

                this.showConfirmDialog(`Remove ${this.congressionalTerms[termId].name}?`, () => {
                    delete this.congressionalTerms[termId];

                    // Switch to another term if we deleted the current one
                    if (this.currentTerm === termId) {
                        this.currentTerm = Object.keys(this.congressionalTerms)[0];
                    }

                    this.renderTabs();

                    // Reload form data and update appearance
                    if (this.selectedDistrict) {
                    this.loadFormDataForTerm();
                        this.updateDistrictAppearance();
                    }
                    this.updateAllBorders();
                });
            }

            saveCurrentFormData() {
                if (!this.selectedDistrict) return;

                const districtName = document.getElementById('districtName').value.trim();
                const margin = parseFloat(document.getElementById('margin').value);

                if (this.isMultiMember) {
                    let incumbentData = [];
                    const rows = document.querySelectorAll('.incumbent-row');
                    rows.forEach(row => {
                        const name = row.querySelector('.incumbent-input').value.trim();
                        const party = row.querySelector('.incumbent-party').value;
                        const marginInput = row.querySelector('.incumbent-margin');
                        const incumbentMargin = marginInput ? parseFloat(marginInput.value) : null;

                        if (name) {
                            incumbentData.push({
                                name,
                                party,
                                margin: isNaN(incumbentMargin) ? null : incumbentMargin
                            });
                        }
                    });

                    if (!this.selectedDistrict) {
                        console.error('No district selected');
                        return;
                    }

                    this.congressionalTerms[this.currentTerm].data[this.selectedDistrict] = {
                        districtName: districtName,
                        incumbents: incumbentData,
                        margin: isNaN(margin) ? null : margin,
                        isMultiMember: true,
                        usePRParties: this.usePRParties
                    };
                } else {
                    const singleIncumbent = document.querySelector('.incumbent-input').value.trim();
                    const party = document.getElementById('party').value;

                    this.congressionalTerms[this.currentTerm].data[this.selectedDistrict] = {
                        districtName: districtName,
                        incumbent: singleIncumbent,
                        margin: isNaN(margin) ? null : margin,
                        party: party,
                        isMultiMember: false,
                        usePRParties: this.usePRParties
                    };
                }
            }

            loadFormDataForTerm() {
                if (!this.selectedDistrict) return;

                const data = this.congressionalTerms[this.currentTerm].data[this.selectedDistrict] || {};

                document.getElementById('districtName').value = data.districtName || '';
                document.getElementById('margin').value = data.margin || '';

                if (data.isMultiMember && data.incumbents && data.incumbents.length > 0) {
                    // Multi-member district
                    document.getElementById('multiMemberToggle').checked = true;
                    this.toggleMultiMember(true);

                    const container = document.getElementById('incumbentContainer');
                    container.innerHTML = ''; // Clear existing

                    data.incumbents.forEach((incumbent, index) => {
                        const partyOptions = this.usePRParties ? `
                            <option value="">Select Party</option>
                            <option value="New Progressive" ${incumbent.party === 'New Progressive' ? 'selected' : ''}>New Progressive</option>
                            <option value="Popular Democratic" ${incumbent.party === 'Popular Democratic' ? 'selected' : ''}>Popular Democratic</option>
                            <option value="Alianza" ${incumbent.party === 'Alianza' ? 'selected' : ''}>Alianza</option>
                            <option value="Project Dignity" ${incumbent.party === 'Project Dignity' ? 'selected' : ''}>Project Dignity</option>
                            <option value="Independent" ${incumbent.party === 'Independent' ? 'selected' : ''}>Independent</option>
                        ` : `
                            <option value="">Select Party</option>
                            <option value="Democratic" ${incumbent.party === 'Democratic' ? 'selected' : ''}>Democratic</option>
                            <option value="Republican" ${incumbent.party === 'Republican' ? 'selected' : ''}>Republican</option>
                            <option value="Independent" ${incumbent.party === 'Independent' ? 'selected' : ''}>Independent</option>
                        `;

                        const newRow = document.createElement('div');
                        newRow.className = 'incumbent-row';
                        newRow.setAttribute('data-index', index);
                        newRow.innerHTML = `
                            <input type="text" class="incumbent-input" placeholder="Enter incumbent name" style="margin-bottom: 8px;" value="${incumbent.name || ''}">
                            <select class="incumbent-party" style="margin-bottom: 8px;">
                                ${partyOptions}
                            </select>
                            <input type="number" class="incumbent-margin" placeholder="Margin %" step="0.1" style="margin-bottom: 8px;" value="${incumbent.margin || ''}">
                            ${index > 0 ? '<button type="button" class="remove-incumbent btn btn-danger" style="font-size: 11px; padding: 4px 8px; margin-bottom: 8px;">Remove</button>' : ''}
                        `;
                        container.appendChild(newRow);

                        if (index > 0) {
                            newRow.querySelector('.remove-incumbent').addEventListener('click', () => {
                                newRow.remove();
                            });
                        }
                    });
                } else {
                    // Single member district
                    document.getElementById('multiMemberToggle').checked = false;
                    this.toggleMultiMember(false);
                    const firstInput = document.querySelector('.incumbent-input');
                    if (firstInput) firstInput.value = data.incumbent || '';
                    document.getElementById('party').value = data.party || '';
                    document.getElementById('margin').value = data.margin || '';
                }

                // Load special election data for term switching
                document.getElementById('specialElectionToggle').checked = data.hasSpecialElection || false;
                this.toggleSpecialElection(data.hasSpecialElection || false);
                if (data.specialElection) {
                    if (data.isMultiMember && data.specialElection.incumbents) {
                        setTimeout(() => {
                            const specialRows = document.querySelectorAll('.special-incumbent-row');
                            data.specialElection.incumbents.forEach((incumbent, index) => {
                                if (specialRows[index]) {
                                    specialRows[index].querySelector('.special-incumbent-input').value = incumbent.name || '';
                                    specialRows[index].querySelector('.special-incumbent-party').value = incumbent.party || '';
                                    specialRows[index].querySelector('.special-incumbent-margin').value = incumbent.margin || '';
                                }
                            });
                        }, 50);
                    } else {
                        document.getElementById('specialIncumbentInput').value = data.specialElection.incumbent || '';
                        document.getElementById('specialIncumbentParty').value = data.specialElection.party || '';
                        document.getElementById('specialIncumbentMargin').value = data.specialElection.margin || '';
                    }
                }
            }

            showModal(title, content) {
                const modal = document.getElementById('modalOverlay');
                const modalContent = document.getElementById('modalContent');

                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2 class="modal-title">${title}</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').classList.remove('show')">×</button>
                    </div>
                    ${content}
                `;

                modal.classList.add('show');
            }

            hideModal() {
                document.getElementById('modalOverlay').classList.remove('show');
            }

            showUploadModal() {
                const content = `
                <div class="file-upload-option" onclick="document.getElementById('mapFileInput').click()">
                    <div class="file-upload-title">Map File</div>
                    <div class="file-upload-desc">Upload GeoJSON, Shapefile, or ZIP file with district boundaries</div>
                </div>

                <div class="file-upload-option" onclick="document.getElementById('dataFileInput').click()">
                    <div class="file-upload-title">District Data File</div>
                    <div class="file-upload-desc">Load previously saved district data (JSON format)</div>
                </div>
            `;

            this.showModal('Load Map Files', content);
            }

            showSettingsModal() {
                const content = `
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Display Options</h3>
                            <label style="display: flex; align-items: center; margin-bottom: 15px;">
                                Auto-zoom to selected districts
                                <div class="switch">
                                    <input type="checkbox" id="modalAutoZoom" ${this.autoZoomEnabled ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 15px;">
                                Toggle Fullscreen
                                <div class="switch">
                                    <input type="checkbox" id="modalFullscreen" ${this.isFullscreen ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 15px;">
                                Switch to Sidebar Editor
                                <div class="switch">
                                    <input type="checkbox" id="modalSidebar" ${!this.isFullscreen ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 15px;">
                                Display Party Counter Chart
                                <div class="switch">
                                    <input type="checkbox" id="modalPartyCounter" ${document.getElementById('partyCounter').style.display !== 'none'}>
                                    <span class="slider"></span>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center;">
                                Enable Dark Mode
                                <div class="switch">
                                    <input type="checkbox" id="modalDarkMode" ${this.darkMode ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </div>
                            </label>
                        </div>

                        <div class="settings-section">
                            <h3>Map Style</h3>
                                <label style="margin-bottom: 15px; display: block;">
                                     Background Map Style:
                                     <select id="modalBackgroundMap" style="width: 100%; padding: 8px; margin-top: 5px;">
                                        <option value="openstreetmap">OpenStreetMap (Default)</option>
                                        <option value="cartodb-light">CartoDB Light (NYT-style)</option>
                                        <option value="cartodb-dark">CartoDB Dark</option>
                                        <option value="stamen-toner">Stamen Toner (B&W)</option>
                                        <option value="esri-world">ESRI World Street</option>
                                        <option value="esri-satellite">ESRI Satellite</option>
                                        <option value="cartodb-positron">CartoDB Positron (Clean)</option>
                                        <option value="cartodb-dark-nolabels">CartoDB Dark (Clean)</option>
                                        <option value="esri-world-gray">ESRI Light Gray</option>
                                        <option value="stamen-terrain">Stamen Terrain</option>
                                    </select>
                                </label>

                                <label style="margin-bottom: 15px; display: block;">
                                    Border Color:
                                    <select id="modalBorderColor" style="width: 100%; padding: 8px; margin-top: 5px;">
                                        <option value="black">Black</option>
                                        <option value="white">White</option>
                                    </select>
                                </label>
                            </div>
                        </div>

                    <div class="settings-section">
                        <h3>District Fill Opacity</h3>
                        <input type="range" id="modalFillOpacity" min="0.1" max="1" value="0.7" step="0.1" style="width: 100%;">
                        <div style="text-align: center; margin-top: 8px;">
                            Current: <span id="modalOpacityValue">0.7</span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Border Fill Opacity</h3>
                        <input type="range" id="modalBorderOpacity" min="0.1" max="1" value="${this.borderOpacity}" step="0.1" style="width: 100%;">
                        <div style="text-align: center; margin-top: 8px;">
                            Current: <span id="modalBorderOpacityValue">${this.borderOpacity}</span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Border Thickness</h3>
                        <input type="range" id="modalBorderThickness" min="0.25" max="4" value="${this.borderThickness}" step="0.25" style="width: 100%;">
                        <div style="text-align: center; margin-top: 8px;">
                            Current: <span id="modalBorderValue">${this.borderThickness}</span>px
                        </div>
                    </div>
                `;

                this.showModal('Map Settings', content);

                // Add event listeners for the modal controls
                this.bindModalSettingsEvents();
            }

            showColorsModal() {
                const content = `
                    <div class="color-option" style="position: relative;">
                        <div class="color-preview" id="demPreview" style="background-color: ${this.partyColors.Democratic};"></div>
                        <div class="color-label">Democratic Party Color</div>
                        <select id="modalDemColor">
                            <option value="#7380D9">Default Blue</option>
                            <option value="#1C408C">YAPMS Blue</option>
                            <option value="#584CDE">Wikipedia Blue</option>
                            <option value="#8F8FFF">DRA Blue</option>
                            <option value="#7F7FC5">DRA Dark Blue</option>
                            <option value="#BF1D29">YAPMS Red</option>
                            <option value="#D72F30">Wikipedia Red</option>
                            <option value="#FF8F8F">DRA Red</option>
                            <option value="#CA7F8B">DRA Dark Red</option>
                            <option value="#1C8C28">YAPMS Green</option>
                            <option value="#E6B700">YAPMS Yellow</option>
                            <option value="#DEB02A">Wikipedia Yellow</option>
                            <option value="#EC7014">Wikipedia Orange</option>
                            <option value="#822194">YAPMS Purple</option>
                            <option value="#737373">Wikipedia Grey</option>
                            <option value="#CCCCCC">YAPMS Tossup</option>
                            <option value="#161687">PR New Progressive</option>
                            <option value="#FF3333">PR Popular Democratic</option>
                            <option value="#E0A230">PR Alianza</option>
                            <option value="#009C4D">PR Alianza Alternate</option>
                            <option value="#00ADC6">PR Project Dignity</option>
                            <option value="custom">Custom Color...</option>
                        </select>
                        <input type="color" id="demColorPicker" style="visibility: hidden; position: absolute; width: 1px; height: 1px;">
                    </div>
                    
                    <div class="color-option" style="position: relative;">
                        <div class="color-preview" id="repPreview" style="background-color: ${this.partyColors.Republican};"></div>
                        <div class="color-label">Republican Party Color</div>
                        <select id="modalRepColor">
                            <option value="#B06361">Default Red</option>
                            <option value="#BF1D29">YAPMS Red</option>
                            <option value="#D72F30">Wikipedia Red</option>
                            <option value="#FF8F8F">DRA Red</option>
                            <option value="#CA7F8B">DRA Dark Red</option>
                            <option value="#1C408C">YAPMS Blue</option>
                            <option value="#584CDE">Wikipedia Blue</option>
                            <option value="#8F8FFF">DRA Blue</option>
                            <option value="#7F7FC5">DRA Dark Blue</option>
                            <option value="#E6B700">YAPMS Yellow</option>
                            <option value="#DEB02A">Wikipedia Yellow</option>
                            <option value="#EC7014">Wikipedia Orange</option>
                            <option value="#822194">YAPMS Purple</option>
                            <option value="#1C8C28">YAPMS Green</option>
                            <option value="#737373">Wikipedia Grey</option>
                            <option value="#CCCCCC">YAPMS Tossup</option>
                            <option value="#161687">PR New Progressive</option>
                            <option value="#FF3333">PR Popular Democratic</option>
                            <option value="#E0A230">PR Alianza</option>
                            <option value="#009C4D">PR Alianza Alternate</option>
                            <option value="#00ADC6">PR Project Dignity</option>
                            <option value="custom">Custom Color...</option>
                        </select>
                        <input type="color" id="repColorPicker" style="visibility: hidden; position: absolute; width: 1px; height: 1px;">
                    </div>

                    <div class="color-option" style="position: relative;">
                        <div class="color-preview" id="indPreview" style="background-color: ${this.partyColors.Independent};"></div>
                        <div class="color-label">Independent Party Color</div>
                        <select id="modalIndColor">
                            <option value="#D9EAD3">Default Green</option>
                            <option value="#1C8C28">YAPMS Green</option>
                            <option value="#E6B700">YAPMS Yellow</option>
                            <option value="#DEB02A">Wikipedia Yellow</option>
                            <option value="#EC7014">Wikipedia Orange</option>
                            <option value="#822194">YAPMS Purple</option>
                            <option value="#1C408C">YAPMS Blue</option>
                            <option value="#584CDE">Wikipedia Blue</option>
                            <option value="#8F8FFF">DRA Blue</option>
                            <option value="#7F7FC5">DRA Dark Blue</option>
                            <option value="#BF1D29">YAPMS Red</option>
                            <option value="#D72F30">Wikipedia Red</option>
                            <option value="#FF8F8F">DRA Red</option>
                            <option value="#CA7F8B">DRA Dark Red</option>
                            <option value="#737373">Wikipedia Grey</option>
                            <option value="#CCCCCC">YAPMS Tossup</option>
                            <option value="#161687">PR New Progressive</option>
                            <option value="#FF3333">PR Popular Democratic</option>
                            <option value="#E0A230">PR Alianza</option>
                            <option value="#009C4D">PR Alianza Alternate</option>
                            <option value="#00ADC6">PR Project Dignity</option>
                            <option value="custom">Custom Color...</option>
                        </select>
                        <input type="color" id="indColorPicker" style="visibility: hidden; position: absolute; width: 1px; height: 1px;">
                    </div>
                    
                    <div class="color-option" style="position: relative;">
                        <div class="color-preview" id="unsetPreview" style="background-color: ${this.partyColors.unset};"></div>
                        <div class="color-label">Unset Party Color</div>
                        <select id="modalUnsetColor">
                            <option value="#AF9A44">Default Yellow</option>
                            <option value="#E6B700">YAPMS Yellow</option>
                            <option value="#DEB02A">Wikipedia Yellow</option>
                            <option value="#737373">Wikipedia Grey</option>
                            <option value="#CCCCCC">YAPMS Tossup</option>
                            <option value="#EC7014">Wikipedia Orange</option>
                            <option value="#822194">YAPMS Purple</option>
                            <option value="#1C8C28">YAPMS Green</option>
                            <option value="#D72F30">Wikipedia Red</option>
                            <option value="#FF8F8F">DRA Red</option>
                            <option value="#CA7F8B">DRA Dark Red</option>
                            <option value="#1C408C">YAPMS Blue</option>
                            <option value="#584CDE">Wikipedia Blue</option>
                            <option value="#8F8FFF">DRA Blue</option>
                            <option value="#7F7FC5">DRA Dark Blue</option>
                            <option value="#161687">PR New Progressive</option>
                            <option value="#FF3333">PR Popular Democratic</option>
                            <option value="#E0A230">PR Alianza</option>
                            <option value="#009C4D">PR Alianza Alternate</option>
                            <option value="#00ADC6">PR Project Dignity</option>
                            <option value="custom">Custom Color...</option>
                        </select>
                        <input type="color" id="unsetColorPicker" style="visibility: hidden; position: absolute; width: 1px; height: 1px;">
                    </div>
                `;

                this.showModal('Color Settings', content);
                this.bindModalColorEvents();
            }

            clearMapData() {
                this.showConfirmDialog('Are you sure you want to clear all district data? The map will remain loaded.', () => {
                    // Only clear the congressional terms data, not the map layer
                    this.congressionalTerms = {
                        'term_1': {
                            name: '118th Congress',
                            data: {}
                        }
                    };
                    this.currentTerm = 'term_1';
                    this.termCounter = 1;
                    this.selectedDistrict = null;

                    this.renderTabs();
                    this.updateAllBorders();
                    this.updatePartyCounter();
                    this.hideDistrictEditor();

                    document.getElementById('status').textContent = 'District data cleared successfully!';
                });
            }

            bindModalSettingsEvents() {
                // Auto-zoom toggle
                document.getElementById('modalAutoZoom').addEventListener('change', (e) => {
                    this.autoZoomEnabled = e.target.checked;
                });

                // Fullscreen toggle
                document.getElementById('modalFullscreen').addEventListener('change', (e) => {
                    if (e.target.checked !== this.isFullscreen) {
                        this.toggleFullscreen();
                    }
                });

                // Sidebar toggle
                document.getElementById('modalSidebar').addEventListener('change', (e) => {
                    if (e.target.checked === this.isFullscreen) {
                        this.toggleFullscreen(); // Enable sidebar
                    } else if (!e.target.checked && !this.isFullscreen) {
                        this.toggleFullscreen(); // Disable sidebar
                    }
                });

                // Party counter toggle
                document.getElementById('modalPartyCounter').addEventListener('change', (e) => {
                    const counter = document.getElementById('partyCounter');
                    counter.style.display = e.target.checked ? 'block' : 'none';
                });

                // Dark mode toggle (placeholder for now (not anymore))
                document.getElementById('modalDarkMode').addEventListener('change', (e) => {
                    this.darkMode = e.target.checked;
                    if (e.target.checked) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                });

                // Background map style
                document.getElementById('modalBackgroundMap').addEventListener('change', (e) => {
                    this.setTileLayer(e.target.value);
                });

                // Border color
                document.getElementById('modalBorderColor').addEventListener('change', (e) => {
                    this.borderColor = e.target.value;
                    this.updateAllBorders();
                });

                // Fill opacity
                document.getElementById('modalFillOpacity').addEventListener('input', (e) => {
                    this.fillOpacity = parseFloat(e.target.value);
                    document.getElementById('modalOpacityValue').textContent = this.fillOpacity;
                    this.updateAllBorders();
                });

                // Border opacity (new feature)
                document.getElementById('modalBorderOpacity').addEventListener('input', (e) => {
                    this.borderOpacity = parseFloat(e.target.value);
                    document.getElementById('modalBorderOpacityValue').textContent = this.borderOpacity;
                    this.updateAllBorders();
                });

                // Border thickness
                document.getElementById('modalBorderThickness').addEventListener('input', (e) => {
                    this.borderThickness = parseFloat(e.target.value);
                    document.getElementById('modalBorderValue').textContent = this.borderThickness;
                    this.updateAllBorders();
                });
            }
            
            bindModalColorEvents() {
                console.log(document.getElementById('demColorPicker'));
                // Add event listeners for color changes
                // Democratic color
                document.getElementById('modalDemColor').addEventListener('change', (e) => {
                    const preview = document.getElementById('demPreview'); // Get the correct preview
                    if (e.target.value === 'custom') {
                        const picker = document.getElementById('demColorPicker');
                        picker.style.visibility = 'visible';
                        picker.click();
                        picker.style.visibility = 'hidden';
                    } else {
                        this.partyColors.Democratic = e.target.value;
                        preview.style.backgroundColor = e.target.value;
                        this.updateAllBorders();
                    }
                });

                document.getElementById('modalRepColor').addEventListener('change', (e) => {
                    console.log('Rep color picker element:', document.getElementById('repColorPicker'));
                    const preview = document.getElementById('repPreview'); // Get the correct preview
                    if (e.target.value === 'custom') {
                        const picker = document.getElementById('repColorPicker');
                        picker.style.visibility = 'visible';
                        picker.click();
                        picker.style.visibility = 'hidden';
                    } else {
                        this.partyColors.Republican = e.target.value;
                        preview.style.backgroundColor = e.target.value;
                        this.updateAllBorders();
                    }
                });

                document.getElementById('modalIndColor').addEventListener('change', (e) => {
                    const preview = document.getElementById('indPreview'); // Get the correct preview
                    if (e.target.value === 'custom') {
                        const picker = document.getElementById('indColorPicker');
                        picker.style.visibility = 'visible';
                        picker.click();
                        picker.style.visibility = 'hidden';
                    } else {
                        this.partyColors.Independent = e.target.value;
                        document.querySelectorAll('.color-preview')[2].style.backgroundColor = e.target.value;
                        preview.style.backgroundColor = e.target.value;
                        this.updateAllBorders();
                    }
                });

                document.getElementById('modalUnsetColor').addEventListener('change', (e) => {
                    console.log('Unset dropdown changed to:', e.target.value);
                    const preview = document.getElementById('unsetPreview'); // Get the correct preview
                    if (e.target.value === 'custom') {
                        console.log('Custom selected for unset');
                        const picker = document.getElementById('unsetColorPicker');
                        console.log('Picker element found:', picker);
                        if (picker) {
                            picker.style.visibility = 'visible';
                            console.log('About to click picker');
                            picker.click();
                            picker.style.visibility = 'hidden';
                        } else {
                            console.log('ERROR: Picker element not found!');
                        }
                    } else {
                        this.partyColors.unset = e.target.value;
                        document.querySelectorAll('.color-preview')[3].style.backgroundColor = e.target.value;
                        preview.style.backgroundColor = e.target.value;
                        this.updateAllBorders();
                    }
                });

                    document.getElementById('demColorPicker').addEventListener('change', (e) => {
                    this.partyColors.Democratic = e.target.value;
                    document.getElementById('demPreview').style.backgroundColor = e.target.value; // Use the specific ID
                    this.updateAllBorders();
                });

                    document.getElementById('repColorPicker').addEventListener('change', (e) => {
                    console.log('Rep color changed to:', e.target.value);
                    this.partyColors.Republican = e.target.value;
                    document.getElementById('repPreview').style.backgroundColor = e.target.value;
                    this.updateAllBorders();
                });

                document.getElementById('indColorPicker').addEventListener('change', (e) => {
                    this.partyColors.Independent = e.target.value;
                    document.getElementById('indPreview').style.backgroundColor = e.target.value;
                    this.updateAllBorders();
                });

                    document.getElementById('unsetColorPicker').addEventListener('change', (e) => {
                    this.partyColors.unset = e.target.value;
                    document.getElementById('unsetPreview').style.backgroundColor = e.target.value;
                    this.updateAllBorders();
                });
            }

            initializeModalDistrictForm(data) {
                console.log('initializeModalDistrictForm called with:', data);
                console.log('Looking for modalSingleIncumbent element:', document.getElementById('modalSingleIncumbent'));

                // New order (CORRECT):

                // Set multi-member state FIRST
                const isMultiMember = data.isMultiMember || false;
                document.getElementById('modalMultiMember').checked = isMultiMember;

                // Set PR parties state first
                // Set PR parties state first (only if custom parties are disabled)
                if (!this.customPartiesEnabled) {
                    const prPartiesEnabled = data.usePRParties || false;
                    document.getElementById('modalPRParties').checked = prPartiesEnabled;
                    this.updateModalPartyOptions(prPartiesEnabled);
                } else {
                    // When custom parties are enabled, force update of all dropdowns
                    this.updateModalPartyOptions(false);
                }

                // Toggle multi-member UI AFTER incumbent section is initialized
                // Set up UI structure first
                this.toggleModalMultiMember(isMultiMember, true); // true = isInitialSetup


                // Create all necessary incumbent rows for multi-member districts
                if (isMultiMember && data.incumbents && data.incumbents.length > 0) {
                    const container = document.getElementById('modalIncumbentContainer');
                    container.innerHTML = ''; // Clear any existing content

                    // Create a row for each incumbent
                    data.incumbents.forEach((incumbent, index) => {
                        this.addModalIncumbentRow({}, index);
                    });
                }

                // Initialize incumbent section
                // Initialize incumbent section AFTER multi-member state is set
                this.populateModalIncumbentData(data);

                // Set single-member party dropdown value
                if (!isMultiMember) {
                    const modalParty = document.getElementById('modalParty');
                    if (modalParty && data.party) {
                        modalParty.value = data.party;
                    }
                }

                // Initialize special election section
                const hasSpecialElection = data.hasSpecialElection || false;
                document.getElementById('modalSpecialElection').checked = hasSpecialElection;
                this.updateModalSpecialElectionSection(hasSpecialElection, data);

                // Find where you try to set the incumbent value and add this:
                const incumbentInput = document.getElementById('modalSingleIncumbent');
                if (incumbentInput) {
                    console.log('Setting modalSingleIncumbent to:', data.incumbent);
                    incumbentInput.value = data.incumbent || '';
                    console.log('Value after setting:', incumbentInput.value);
                } else {
                    console.log('modalSingleIncumbent not found!');
                }
            }

            updateModalIncumbentSection(data) {
                const container = document.getElementById('modalIncumbentContainer');
                const isMultiMember = data.isMultiMember || false;

                if (isMultiMember && data.incumbents && data.incumbents.length > 0) {
                    // Multi-member district
                    container.innerHTML = '';
                    data.incumbents.forEach((incumbent, index) => {
                        this.addModalIncumbentRow(incumbent, index);
                    });
                } else {
                    // Single member district
                    const incumbentName = data.incumbent || '';
                    container.innerHTML = `
                        <input type="text" id="modalSingleIncumbent" value="${incumbentName}" placeholder="Enter incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                    `;
                }
            }

            populateModalIncumbentData(data) {
                const isMultiMember = data.isMultiMember || false;

                if (isMultiMember && data.incumbents && data.incumbents.length > 0) {
                    // Populate multi-member incumbent data
                    const rows = document.querySelectorAll('.modal-incumbent-row');
                    data.incumbents.forEach((incumbent, index) => {
                        if (rows[index]) {
                            const nameInput = rows[index].querySelector('.modal-incumbent-input');
                            const partySelect = rows[index].querySelector('.modal-incumbent-party');
                            const marginInput = rows[index].querySelector('.modal-incumbent-margin');

                            if (nameInput) nameInput.value = incumbent.name || '';
                            if (partySelect) partySelect.value = incumbent.party || '';
                            if (marginInput) marginInput.value = incumbent.margin || '';
                        }
                    });
                } else {
                    // Populate single-member incumbent data
                    const singleIncumbent = document.getElementById('modalSingleIncumbent');
                    if (singleIncumbent) {
                        singleIncumbent.value = data.incumbent || '';
                    }
                }
            }

            addModalIncumbentRow(incumbent = {}, index = 0) {
                // Check if special elections are enabled and update special election section
                const isSpecialElectionEnabled = document.getElementById('modalSpecialElection')?.checked;

                const container = document.getElementById('modalIncumbentContainer');
                const isFirstRow = index === 0;

                const partyOptions = this.getPartyOptionsHTML(incumbent.party);

                const rowHtml = `
                    <div class="modal-incumbent-row" data-index="${index}" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
                        <input type="text" class="modal-incumbent-input" placeholder="Enter incumbent name" value="${incumbent.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; margin-bottom: 8px; background: white;">
                        <select class="modal-incumbent-party" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; margin-bottom: 8px; background: white;">
                            ${partyOptions}
                        </select>
                        <input type="number" class="modal-incumbent-margin" placeholder="Margin %" step="0.1" value="${incumbent.margin || ''}" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; margin-bottom: 8px; background: white;">
                        ${!isFirstRow ? '<button type="button" class="modal-remove-incumbent" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>' : ''}
                    </div>
                `;

                container.innerHTML += rowHtml;

                // Add remove functionality if not first row
                if (!isFirstRow) {
                    const newRow = container.lastElementChild;
                    newRow.querySelector('.modal-remove-incumbent').addEventListener('click', () => {
                        newRow.remove();
                        // Update special election section when incumbent is removed
                        if (isSpecialElectionEnabled) {
                            this.updateModalSpecialElectionSection(true);
                        }
                    });
                }

                // Update special election section if enabled
                if (isSpecialElectionEnabled) {
                    this.updateModalSpecialElectionSection(true);
                }
            }

            getPartyOptionsHTML(selectedParty = '') {
                if (this.customPartiesEnabled && this.customParties.length > 0) {
                    // Use custom parties
                    let options = '<option value="">Select Party</option>';
                    this.customParties.forEach(party => {
                        options += `<option value="${party.name}" ${selectedParty === party.name ? 'selected' : ''}>${party.name}</option>`;
                    });
                    return options;
                }

                const prPartiesEnabled = document.getElementById('modalPRParties')?.checked || this.usePRParties;

                if (prPartiesEnabled) {
                    return `
                        <option value="">Select Party</option>
                        <option value="New Progressive" ${selectedParty === 'New Progressive' ? 'selected' : ''}>New Progressive</option>
                        <option value="Popular Democratic" ${selectedParty === 'Popular Democratic' ? 'selected' : ''}>Popular Democratic</option>
                        <option value="Alianza" ${selectedParty === 'Alianza' ? 'selected' : ''}>Alianza</option>
                        <option value="Project Dignity" ${selectedParty === 'Project Dignity' ? 'selected' : ''}>Project Dignity</option>
                        <option value="Independent" ${selectedParty === 'Independent' ? 'selected' : ''}>Independent</option>
                    `;
                } else {
                    return `
                        <option value="">Select Party</option>
                        <option value="Democratic" ${selectedParty === 'Democratic' ? 'selected' : ''}>Democratic</option>
                        <option value="Republican" ${selectedParty === 'Republican' ? 'selected' : ''}>Republican</option>
                        <option value="Independent" ${selectedParty === 'Independent' ? 'selected' : ''}>Independent</option>
                    `;
                }
            }
            
            updateModalPartyOptions(prPartiesEnabled) {
                const partySelect = document.getElementById('modalParty');
                if (partySelect) {
                    const currentValue = partySelect.value;
                    partySelect.innerHTML = this.getPartyOptionsHTML(currentValue);
                }

                // Update all incumbent party selects
                const incumbentPartySelects = document.querySelectorAll('.modal-incumbent-party');
                incumbentPartySelects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = this.getPartyOptionsHTML(currentValue);
                });

                // Update special election party selects
                const specialPartySelect = document.getElementById('modalSpecialParty');
                if (specialPartySelect) {
                    const currentValue = specialPartySelect.value;
                    specialPartySelect.innerHTML = this.getPartyOptionsHTML(currentValue);
                }

                const specialIncumbentPartySelects = document.querySelectorAll('.modal-special-incumbent-party');
                specialIncumbentPartySelects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = this.getPartyOptionsHTML(currentValue);
                });
            }

            toggleModalMultiMember(isMultiMember, isInitialSetup = false) {
                const addButton = document.getElementById('modalAddIncumbent');
                const singleControls = document.getElementById('modalSingleControls');
                const container = document.getElementById('modalIncumbentContainer');

                if (isMultiMember) {
                    // Show multi-member controls
                    addButton.style.display = 'block';
                    singleControls.style.display = 'none';

                    // Preserve existing single incumbent data
                    const singleIncumbent = document.getElementById('modalSingleIncumbent');
                    const incumbentName = singleIncumbent ? singleIncumbent.value : '';

                    // Clear and rebuild container for multi-member
                    container.innerHTML = '';
                    this.addModalIncumbentRow({ name: incumbentName }, 0);
                } else {
                    // Show single-member controls
                    addButton.style.display = 'none';
                    singleControls.style.display = 'block';

                    // Only rebuild container if this is a mode switch, not initial setup
                    if (!isInitialSetup) {
                        // Preserve first incumbent data
                        const firstIncumbent = container.querySelector('.modal-incumbent-input');
                        const incumbentName = firstIncumbent ? firstIncumbent.value : '';

                        // Reset to single incumbent
                        container.innerHTML = `
                        <input type="text" id="modalSingleIncumbent" value="${incumbentName}" placeholder="Enter incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                        `;
                    }
                }
            }

            updateModalSpecialElectionSection(hasSpecialElection, data = {}) {
                const container = document.getElementById('modalSpecialElectionContainer');
                const isMultiMember = document.getElementById('modalMultiMember').checked;

                if (hasSpecialElection) {
                    container.style.display = 'block';
                    const specialData = data.specialElection || {};

                    if (isMultiMember) {
                        // Multi-member special elections
                        const incumbentCount = document.querySelectorAll('.modal-incumbent-row').length || 1;
                        container.innerHTML = '<label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbents:</label>';

                        for (let i = 0; i < incumbentCount; i++) {
                            const incumbent = specialData.incumbents && specialData.incumbents[i] ? specialData.incumbents[i] : {};
                            container.innerHTML += `
                                <div class="modal-special-incumbent-row" data-index="${i}" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ecf0f1; border-radius: 8px; background: rgba(248, 249, 250, 0.5);">
                                    <input type="text" class="modal-special-incumbent-input" value="${incumbent.name || ''}" placeholder="Special incumbent ${i + 1}" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 12px; margin-bottom: 8px;">
                                    <select class="modal-special-incumbent-party" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 12px; margin-bottom: 8px;">
                                        ${this.getPartyOptionsHTML(incumbent.party)}
                                    </select>
                                    <input type="number" class="modal-special-incumbent-margin" value="${incumbent.margin || ''}" placeholder="Margin %" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 12px;">
                                </div>
                            `;
                        }
                    } else {
                        // Single member special election
                        container.innerHTML = `
                            <label style="color: #34495e; font-weight: 500; margin-bottom: 8px; display: block;">Special Election Incumbent:</label>
                            <input type="text" id="modalSpecialIncumbent" value="${specialData.incumbent || ''}" placeholder="Enter special election incumbent name" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; margin-bottom: 8px; background: white;">
                            <select id="modalSpecialParty" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; margin-bottom: 8px; background: white;">
                                ${this.getPartyOptionsHTML(specialData.party)}
                            </select>
                            <input type="number" id="modalSpecialMargin" value="${specialData.margin || ''}" placeholder="Special election margin %" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ecf0f1; border-radius: 4px; font-size: 14px; background: white;">
                        `;
                    }
                } else {
                    container.style.display = 'none';
                    container.innerHTML = '';
                }
            }

            bindModalDistrictEvents(uniqueId) {
                // Update button
                document.getElementById('modalUpdateDistrict').addEventListener('click', () => {
                    this.updateDistrictDataFromModal(uniqueId);
                    this.hideModal();
                });

                // Multi-member toggle
                document.getElementById('modalMultiMember').addEventListener('change', (e) => {
                    this.toggleModalMultiMember(e.target.checked);
                    if (e.target.checked) {
                        // Convert single incumbent to first multi-member slot
                        const singleIncumbent = document.getElementById('modalSingleIncumbent');
                        if (singleIncumbent && singleIncumbent.value) {
                            this.addModalIncumbentRow({ name: singleIncumbent.value }, 0);
                        } else {
                            this.addModalIncumbentRow({}, 0);
                        }
                    } else {
                        // Convert back to single incumbent
                        const container = document.getElementById('modalIncumbentContainer');
                        const firstIncumbent = container.querySelector('.modal-incumbent-input');
                        const incumbentName = firstIncumbent ? firstIncumbent.value : '';
                        container.innerHTML = `
                            <input type="text" id="modalSingleIncumbent" value="${incumbentName}" placeholder="Enter incumbent name" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.9);">
                        `;
                    }
                });

                // PR parties toggle
                document.getElementById('modalPRParties').addEventListener('change', (e) => {
                    this.updateModalPartyOptions(e.target.checked);
                    // Also update special election party options if special elections are enabled
                    if (document.getElementById('modalSpecialElection').checked) {
                        this.updateModalSpecialElectionSection(true);
                    }
                });
    
                // Special election toggle
                document.getElementById('modalSpecialElection').addEventListener('change', (e) => {
                    this.updateModalSpecialElectionSection(e.target.checked);
                });
    
                // Add incumbent button
                document.getElementById('modalAddIncumbent').addEventListener('click', () => {
                    const container = document.getElementById('modalIncumbentContainer');
                    const currentRows = container.querySelectorAll('.modal-incumbent-row').length;
                    this.addModalIncumbentRow({}, currentRows);

                    // If special elections are enabled, update the special election section
                    if (document.getElementById('modalSpecialElection')?.checked) {
                        setTimeout(() => {
                            this.updateModalSpecialElectionSection(true);
                        }, 50);
                    }
                });
            }

            updateDistrictDataFromModal(uniqueId) {
                const districtName = document.getElementById('modalDistrictName').value.trim();
                const isMultiMember = document.getElementById('modalMultiMember').checked;
                const usePRParties = document.getElementById('modalPRParties').checked;
                const hasSpecialElection = document.getElementById('modalSpecialElection').checked;

                let districtData = {
                    districtName: districtName,
                    isMultiMember: isMultiMember,
                    usePRParties: usePRParties,
                    hasSpecialElection: hasSpecialElection
                };

                if (isMultiMember) {
                    // Collect multi-member data
                    const incumbents = [];
                    const rows = document.querySelectorAll('.modal-incumbent-row');
                    rows.forEach(row => {
                        const name = row.querySelector('.modal-incumbent-input').value.trim();
                        const party = row.querySelector('.modal-incumbent-party').value;
                        const margin = parseFloat(row.querySelector('.modal-incumbent-margin').value);

                        if (name) {
                            incumbents.push({
                                name: name,
                                party: party,
                                margin: isNaN(margin) ? null : margin
                            });
                        }
                    });
                    districtData.incumbents = incumbents;
                } else {
                    // Collect single-member data
                    const incumbent = document.getElementById('modalSingleIncumbent').value.trim();
                    const party = document.getElementById('modalParty').value;
                    const margin = parseFloat(document.getElementById('modalMargin').value);

                    districtData.incumbent = incumbent;
                    districtData.party = party;
                    districtData.margin = isNaN(margin) ? null : margin;
                }

                // Collect special election data
                if (hasSpecialElection) {
                    if (isMultiMember) {
                        // Multi-member special elections
                        const specialIncumbents = [];
                        const specialRows = document.querySelectorAll('.modal-special-incumbent-row');
                        specialRows.forEach(row => {
                            const name = row.querySelector('.modal-special-incumbent-input')?.value.trim();
                            const party = row.querySelector('.modal-special-incumbent-party')?.value;
                            const margin = parseFloat(row.querySelector('.modal-special-incumbent-margin')?.value);

                            if (name) {
                                specialIncumbents.push({
                                    name: name,
                                    party: party,
                                    margin: isNaN(margin) ? null : margin
                                });
                            }
                        });

                        if (specialIncumbents.length > 0) {
                            districtData.specialElection = { incumbents: specialIncumbents };
                        }
                    } else {
                        // Single-member special election
                        const specialIncumbentEl = document.getElementById('modalSpecialIncumbent');
                        const specialPartyEl = document.getElementById('modalSpecialParty');
                        const specialMarginEl = document.getElementById('modalSpecialMargin');

                        if (specialIncumbentEl && specialPartyEl && specialMarginEl) {
                            const specialIncumbent = specialIncumbentEl.value.trim();
                            const specialParty = specialPartyEl.value;
                            const specialMargin = parseFloat(specialMarginEl.value);


                            if (specialIncumbent) {
                                districtData.specialElection = {
                                    incumbent: specialIncumbent,
                                    party: specialParty,
                                    margin: isNaN(specialMargin) ? null : specialMargin
                                };
                            }
                        }
                    }
                }

                // Save the data
                this.congressionalTerms[this.currentTerm].data[uniqueId] = districtData;

                // Update visual appearance
                this.updateDistrictAppearance();

                const displayName = districtName || 'Unnamed District';
                document.getElementById('status').textContent = `Updated ${displayName}`;
            }

            showConfirmDialog(message, onConfirm) {
                const content = `
                    <p style="margin-bottom: 30px; font-size: 16px; line-height: 1.5;">${message}</p>
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button id="confirmCancel" class="btn" style="background: #95a5a6;">Cancel</button>
                        <button id="confirmOk" class="btn btn-danger">Confirm</button>
                    </div>
                `;

                this.showModal('Confirm Action', content);

                document.getElementById('confirmCancel').addEventListener('click', () => {
                    this.hideModal();
                });

                document.getElementById('confirmOk').addEventListener('click', () => {
                    this.hideModal();
                    onConfirm();
                });
            }

            showCustomPartiesModal() {
                const content = `
                    <div class="settings-section" style="margin-bottom: 30px;">
                        <label style="display: flex; align-items: center; margin-bottom: 20px;">
                            Enable Custom Parties
                            <div class="switch">
                                <input type="checkbox" id="customPartiesToggle" ${this.customPartiesEnabled ? 'checked' : ''}>
                                <span class="slider"></span>
                            </div>
                        </label>
                    </div>

                    <div id="customPartiesContainer" style="${this.customPartiesEnabled ? 'display: block;' : 'display: none;'}">
                        <button id="addCustomParty" class="btn" style="margin-bottom: 20px;">Add Custom Party</button>

                        <div id="customPartiesList">
                            ${this.renderCustomPartiesList()}
                        </div>
                    </div>
                `;

                this.showModal('Custom Parties', content);
                this.bindCustomPartiesEvents();
                this.updatePRPartiesVisibility();
            }

            renderCustomPartiesList() {
                return this.customParties.map((party, index) => `
                    <div class="custom-party-item" data-index="${index}" style="background: #f8f9fa; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid ${party.color};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #2c3e50;">${party.name}</h4>
                            <button class="remove-custom-party btn-danger" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">Remove</button>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 120px 40px; gap: 15px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Party Name:</label>
                                <input type="text" class="custom-party-name" value="${party.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Abbreviation (4 chars max):</label>
                                <input type="text" class="custom-party-abbrev" value="${party.abbreviation}" maxlength="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>

                            <div style="text-align: center;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Color:</label>
                                <input type="color" class="custom-party-color" value="${party.color}" style="width: 40px; height: 35px; border: none; border-radius: 4px; cursor: pointer;">
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            bindCustomPartiesEvents() {
                // Toggle custom parties
                document.getElementById('customPartiesToggle').addEventListener('change', (e) => {
                    this.customPartiesEnabled = e.target.checked;
                    const container = document.getElementById('customPartiesContainer');
                    container.style.display = e.target.checked ? 'block' : 'none';

                    // Update visibility of PR parties toggle
                    this.updatePRPartiesVisibility();

                    // Update all party dropdowns when toggling
                    this.updateAllPartyDropdowns();
                });

                // Add custom party
                document.getElementById('addCustomParty').addEventListener('click', () => {
                    this.addCustomParty();
                });

                // Bind events for existing parties
                this.bindCustomPartyItemEvents();
            }

            bindCustomPartyItemEvents() {
                // Remove party buttons
                document.querySelectorAll('.remove-custom-party').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('.custom-party-item').dataset.index);
                        this.removeCustomParty(index);
                    });
                });

                // Update party data when inputs change
                document.querySelectorAll('.custom-party-name').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const index = parseInt(e.target.closest('.custom-party-item').dataset.index);
                        this.customParties[index].name = e.target.value;
                        this.updateAllPartyDropdowns();
                    });
                });

                document.querySelectorAll('.custom-party-abbrev').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const index = parseInt(e.target.closest('.custom-party-item').dataset.index);
                        this.customParties[index].abbreviation = e.target.value;
                    });
                });

                document.querySelectorAll('.custom-party-color').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.closest('.custom-party-item').dataset.index);
                        this.customParties[index].color = e.target.value;
                        this.updateAllBorders();
                    });
                });
            }

            addCustomParty() {
                const newParty = {
                    name: `Custom Party ${this.customParties.length + 1}`,
                    abbreviation: `CP${this.customParties.length + 1}`,
                    color: '#667eea'
                };

                this.customParties.push(newParty);
                document.getElementById('customPartiesList').innerHTML = this.renderCustomPartiesList();
                this.bindCustomPartyItemEvents();
                this.updateAllPartyDropdowns();
            }

            removeCustomParty(index) {
                this.customParties.splice(index, 1);
                document.getElementById('customPartiesList').innerHTML = this.renderCustomPartiesList();
                this.bindCustomPartyItemEvents();
                this.updateAllPartyDropdowns();
            }

            updateAllPartyDropdowns() {
                // Update all party selects in the main form
                const partySelects = document.querySelectorAll('#party, .incumbent-party, #specialIncumbentParty');
                partySelects.forEach(select => {
                    const currentValue = select.value;
                    if (this.customPartiesEnabled) {
                        let options = '<option value="">Select Party</option>';
                        this.customParties.forEach(party => {
                            options += `<option value="${party.name}" ${currentValue === party.name ? 'selected' : ''}>${party.name}</option>`;
                        });
                        select.innerHTML = options;
                    } else {
                        select.innerHTML = this.getPartyOptionsHTML(currentValue);
                    }
                });

                // Update PR parties visibility
                this.updatePRPartiesVisibility();
            }

            updatePRPartiesVisibility() {
                const prPartiesGroup = document.getElementById('prPartiesGroup');
                if (prPartiesGroup) {
                    prPartiesGroup.style.display = this.customPartiesEnabled ? 'none' : 'block';
                }

                // Also handle in modal if it exists
                const modalPRParties = document.getElementById('modalPRParties');
                if (modalPRParties) {
                    const modalPRContainer = modalPRParties.closest('label');
                    if (modalPRContainer) {
                        modalPRContainer.style.display = this.customPartiesEnabled ? 'none' : 'block';
                    }
                }
            }
        }

        // Global reference for modal close buttons
        let mapTool;
        document.addEventListener('DOMContentLoaded', () => {
            mapTool = new CongressionalMapTool();
        });
    </script>
</body>
</html>